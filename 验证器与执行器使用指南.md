# 验证器与执行器使用指南

## 1. 核心约定
- 验证器只负责“读配置 → 执行 SQL → 返回结果”
- 执行器只负责“读配置 → 调用 SQL/Java/Proc”
- 两者只通过业务字段关联，不与按钮耦合
- 配置驱动：每张表只需要维护 `VALIDATION_RULES` 与 `ACTION_RULES`

## 2. 验证器（VALIDATION_RULES）
配置位置：`T_COST_TABLE_METADATA.VALIDATION_RULES`（JSON 数组）

字段说明：
| 字段 | 必填 | 说明 |
| --- | --- | --- |
| `order` | 否 | 执行顺序，默认 0 |
| `code` | 否 | 规则编码，建议唯一 |
| `name` | 否 | 规则名称 |
| `group` | 否 | 分组，不填表示全局规则 |
| `sql` | 是 | 验证 SQL（支持 `:param` 占位符） |
| `condition` | 是 | 条件表达式，如 `result == 0` |
| `message` | 否 | 失败提示 |

`condition` 支持：`==`、`!=`、`>`、`>=`、`<`、`<=`（比较 SQL 返回的 `result`）

SQL 模板示例：
```json
[
  {
    "order": 10,
    "code": "uniqueUsername",
    "group": "save",
    "sql": "SELECT COUNT(1) FROM T_COST_USER WHERE USERNAME = :username AND DELETED = 0 AND ID <> :id",
    "condition": "result == 0",
    "message": "用户名已存在"
  }
]
```

## 3. 执行器（ACTION_RULES）
配置位置：`T_COST_TABLE_METADATA.ACTION_RULES`（JSON 数组）

字段说明：
| 字段 | 必填 | 说明 |
| --- | --- | --- |
| `order` | 否 | 执行顺序，默认 0 |
| `code` | 否 | 执行器编码，建议唯一 |
| `name` | 否 | 执行器名称 |
| `group` | 否 | 分组，不填表示全局规则 |
| `enabled` | 否 | 是否启用，默认启用 |
| `type` | 是 | 执行器类型：`sql` / `java` / `proc` |
| `sql` | 条件 | SQL 执行器必填 |
| `handler` | 条件 | Java 执行器（ActionHandler Bean 名） |
| `method` | 条件 | Java 执行器（beanName.methodName） |
| `procedure` | 条件 | 存储过程名称 |
| `params` | 否 | 存储过程参数 |
| `description` | 否 | 说明 |

说明：当同时传入 `actionCodes` 与 `group` 时，优先使用 `actionCodes` 过滤。

### 3.1 SQL 执行器
- 使用 `:param` 语法，从 `data` 中取值
- 只支持从 `data` 取值，不直接读取 `vars`

示例：
```json
{
  "code": "disableUser",
  "group": "manual",
  "type": "sql",
  "sql": "UPDATE T_COST_USER SET ENABLED = 0 WHERE ID = :id",
  "description": "禁用用户"
}
```

### 3.2 Java 执行器
两种方式：
1. `handler`：实现 `ActionHandler` 接口
2. `method`：指定 `beanName.methodName`，方法签名为 `(ActionContext) -> ActionResult`

示例配置：
```json
{
  "code": "resetPassword",
  "group": "manual",
  "type": "java",
  "method": "userService.resetPassword",
  "description": "重置密码"
}
```

示例方法签名：
```java
public ActionResult resetPassword(ActionContext context) {
    // context.getData() 中包含 id、前端入参等
    // 可在这里完成加密、校验、写库等逻辑
    return ActionResult.empty();
}
```

### 3.3 存储过程执行器
`params` 支持 `IN/OUT/INOUT`，`jdbcType` 取值来自 `org.apache.ibatis.type.JdbcType`。

参数字段：
| 字段 | 说明 |
| --- | --- |
| `mode` | `IN` / `OUT` / `INOUT`，默认 `IN` |
| `jdbcType` | 如 `VARCHAR` / `NUMBER` / `DATE` |
| `source` | 取值来源：`data.xxx` / `vars.xxx` / `xxx` |
| `target` | 写回目标：`data.xxx` / `vars.xxx` / `xxx` |

示例：
```json
{
  "code": "calcCost",
  "group": "after_save",
  "type": "proc",
  "procedure": "PKG_COST.CALC_COST",
  "params": [
    { "mode": "IN", "jdbcType": "NUMBER", "source": "data.id" },
    { "mode": "OUT", "jdbcType": "NUMBER", "target": "data.totalCost" }
  ]
}
```

如果后续 SQL 需要使用输出值，请写回 `data.xxx`，SQL 才能读取到。

## 4. 变量与数据传递
- `data`：请求入参（SQL 执行器只读它）
- `vars`：执行器之间的临时变量（Java/Proc 可写入）

建议：
- 需要给后续 SQL 使用的值，写入 `data.xxx`
- 只在 Java/Proc 之间传递时，可写入 `vars.xxx`

## 5. 调用方式

### 5.1 保存流程（系统自动）
- 保存时自动验证 `group=save`
- 保存成功后自动执行 `group=after_save`

### 5.2 只验证
```json
POST /api/data/CostUser/validate
{ "group": "save", "data": { "id": 1, "username": "tom" } }
```

### 5.3 执行器（不验证）
```json
POST /api/data/CostUser/execute
{ "actionCodes": ["resetPassword"], "data": { "id": 1 } }
```

### 5.4 执行器（先验证）
```json
POST /api/data/CostUser/execute
{ "group": "manual", "validate": true, "validateGroup": "save", "data": { "id": 1 } }
```

### 5.5 执行指定分组
```json
POST /api/data/CostUser/execute
{ "group": "manual", "data": { "id": 1 } }
```

## 6. 典型场景示例

### 6.1 保存后加密密码
```json
{
  "code": "encryptPassword",
  "group": "after_save",
  "type": "java",
  "method": "userService.encryptPassword",
  "description": "保存后加密密码"
}
```

### 6.2 右键菜单“重置密码”
```json
{
  "code": "resetPassword",
  "group": "manual",
  "type": "java",
  "method": "userService.resetPassword",
  "description": "重置密码为默认值"
}
```

> 默认密码如 `Abc123..` 建议在 Java 方法中做加密与落库，避免明文写在 SQL 中。

### 6.3 SQL 直接更新字段
```json
{
  "code": "markDeleted",
  "group": "manual",
  "type": "sql",
  "sql": "UPDATE T_COST_USER SET DELETED = 1 WHERE ID = :id",
  "description": "逻辑删除"
}
```

### 6.4 存储过程计算后再 SQL 更新
```json
[
  {
    "order": 10,
    "code": "calcCost",
    "group": "after_save",
    "type": "proc",
    "procedure": "PKG_COST.CALC_COST",
    "params": [
      { "mode": "IN", "jdbcType": "NUMBER", "source": "data.id" },
      { "mode": "OUT", "jdbcType": "NUMBER", "target": "data.totalCost" }
    ]
  },
  {
    "order": 20,
    "code": "saveCost",
    "group": "after_save",
    "type": "sql",
    "sql": "UPDATE T_COST_ORDER SET TOTAL_COST = :totalCost WHERE ID = :id"
  }
]
```

## 7. 返回结果

### 7.1 ValidationReport
```json
{
  "passed": true,
  "message": null,
  "results": [
    { "code": "uniqueUsername", "passed": true, "result": 0 }
  ]
}
```

### 7.2 ActionExecutionReport
```json
{
  "executedActions": ["resetPassword"],
  "vars": {}
}
```

## 8. 注意事项
- `group` 为空会匹配所有分组，建议显式配置
- SQL 模板使用 `:param` 占位符，未提供的参数会被替换为 `NULL`
- `actionCodes` 有值时，分组 `group` 不参与过滤
- 权限控制不在执行器内处理，请在按钮或上游接口中控制

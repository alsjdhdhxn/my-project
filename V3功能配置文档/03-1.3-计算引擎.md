# 1.3 计算引擎（配置说明）

## 配置入口
1) **列级规则（推荐，写在 rulesConfig）**
- T_COST_COLUMN_METADATA / COLUMN_OVERRIDE.rulesConfig
- `calculate` 字段支持单公式与多公式
2) **页面规则（T_COST_PAGE_RULE）**
- CALC：主表/从表计算
- AGGREGATE：聚合规则
- BROADCAST：主表广播字段
3) **TABS.componentConfig**（用于从表层级）
- calcRules / aggregates / postProcess / masterCalcRules

> 规则执行顺序：
> 1) 行级计算（calcRules）
> 2) 聚合计算（AGGREGATE 的 algorithm）
> 3) 聚合表达式（AGGREGATE 的 expression）
> 4) 主表计算（masterCalcRules）

## 规则结构说明
### 行级计算（CalcRule）
```json
{
  "field": "costBatch",
  "expression": "qty * price",
  "triggerFields": ["qty","price"],
  "condition": "useFlag !== '停用'",
  "order": 10
}
```

### 多公式（formulaField + formulas）
```json
{
  "field": "amount",
  "formulaField": "priceType",
  "formulas": {
    "含税": {"expression":"qty * price","triggerFields":["qty","price"]},
    "未税": {"expression":"qty * price / 1.13","triggerFields":["qty","price"]}
  }
}
```

### 聚合（AggRule）
```json
[
  {"sourceField":"costBatch","targetField":"totalYl","algorithm":"SUM","filter":"dtlUseflag === '原料'"},
  {"targetField":"totalCost","expression":"totalYl + totalFl + totalBc"}
]
```

### 广播字段（Broadcast）
```json
["taxRate","apexPl","yield"]
```

## 配置示例 A：列 rulesConfig（单公式）
```sql
-- 通过 COLUMN_OVERRIDE 注入 rulesConfig（如果列元数据没有 rulesConfig 字段）
INSERT INTO T_COST_PAGE_RULE (ID, PAGE_CODE, COMPONENT_KEY, RULE_TYPE, RULES, SORT_ORDER, CREATE_BY)
VALUES (
  SEQ_COST_PAGE_RULE.NEXTVAL,
  'cost-demo',
  'masterGrid',
  'COLUMN_OVERRIDE',
  q'~[
    {"field":"costBatch","rulesConfig":{"calculate":{"expression":"qty * price","triggerFields":["qty","price"]}}}
  ]~',
  0,
  'system'
);
```

## 配置示例 B：从表聚合 + 税率后处理
```sql
INSERT INTO T_COST_PAGE_RULE (ID, PAGE_CODE, COMPONENT_KEY, RULE_TYPE, RULES, CREATE_BY)
VALUES (
  SEQ_COST_PAGE_RULE.NEXTVAL,
  'cost-demo',
  'masterGrid',
  'AGGREGATE',
  q'~[
    {"sourceField":"costBatch","targetField":"totalYl","algorithm":"SUM","filter":"dtlUseflag === '原料'"},
    {"sourceField":"costBatch","targetField":"totalFl","algorithm":"SUM","filter":"dtlUseflag === '辅料'"},
    {"targetField":"totalYl","expression":"totalYl > 0 ? totalYl / 1.13 : totalYl"},
    {"targetField":"totalFl","expression":"totalFl > 0 ? totalFl / 1.13 : totalFl"},
    {"targetField":"totalCost","expression":"totalYl + totalFl"}
  ]~',
  'system'
);
```

## 配置示例 C：TABS componentConfig 中的 calcRules/aggregates
```json
{
  "mode": "group",
  "groupField": "dtlType",
  "tabs": [...],
  "broadcast": ["taxRate"],
  "calcRules": [
    {"field":"costBatch","expression":"qty * price","triggerFields":["qty","price"]}
  ],
  "aggregates": [
    {"sourceField":"costBatch","targetField":"totalCost","algorithm":"SUM"}
  ],
  "postProcess": "if (totalCost > 0) { totalCost = totalCost / 1.13; }"
}
```

## 多种配置情况
1) **行级计算仅写列 rulesConfig**：适合简单字段公式。
2) **页面规则 CALC**：适合集中管理计算规则（主表/从表分开写到不同 componentKey）。
3) **聚合 + 表达式 + 后处理**：用于“先汇总，再公式，再修正”的链式计算。

## 注意事项
- `AGGREGATE` 规则 **只会读取同组件的第一条规则**（按 sortOrder 选中）。请确保不要重复配置，否则后续规则会被忽略。
- `sourceTab` 字段在 V3 当前实现**不会生效**（聚合计算使用传入的 rows 数组，不区分 Tab）。如需按 Tab 精确过滤，请在 filter 中显式判断字段（如 `dtlUseflag === '原料'`）。
- `postProcess` 是 JS 片段，运行在浏览器环境，请避免复杂或不安全逻辑。

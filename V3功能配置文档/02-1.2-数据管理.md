# 1.2 数据管理（主/从表 CRUD）配置说明

## 配置入口
1) **T_COST_TABLE_METADATA**：主表/从表基础信息（表编码、主键、目标表、序列、父子关系）
2) **T_COST_COLUMN_METADATA**：字段映射、数据类型、显示顺序
3) **T_COST_PAGE_COMPONENT**：主表 GRID / 明细 TABS 关联到正确的 tableCode

> 说明：CRUD 逻辑由动态数据接口完成（/api/data），前端无需额外配置行为开关。

## 必备配置（主表）
```sql
INSERT INTO T_COST_TABLE_METADATA (ID, TABLE_CODE, TABLE_NAME, QUERY_VIEW, TARGET_TABLE, SEQUENCE_NAME, PK_COLUMN, CREATE_BY)
VALUES (SEQ_COST_TABLE_METADATA.NEXTVAL, 'CostMaster', '成本主表', 'V_COST_MASTER', 'T_COST_MASTER', 'SEQ_COST_MASTER', 'ID', 'system');
```

## 必备配置（从表）
```sql
INSERT INTO T_COST_TABLE_METADATA (
  ID, TABLE_CODE, TABLE_NAME, QUERY_VIEW, TARGET_TABLE, SEQUENCE_NAME,
  PK_COLUMN, PARENT_TABLE_CODE, PARENT_FK_COLUMN, CREATE_BY
)
VALUES (
  SEQ_COST_TABLE_METADATA.NEXTVAL,
  'CostDetail',
  '成本明细',
  'V_COST_DETAIL',
  'T_COST_DETAIL',
  'SEQ_COST_DETAIL',
  'ID',
  'CostMaster',
  'MASTER_ID',
  'system'
);
```

## 必备配置（列元数据示例）
```sql
INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, CREATE_BY)
VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, :masterId, 'name', 'NAME', '名称', 'text', 10, 'system');

INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, CREATE_BY)
VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, :detailId, 'masterId', 'MASTER_ID', '主表ID', 'number', 1, 'system');
```

## 页面组件绑定（确保 CRUD 指向正确表）
```sql
-- 主表 Grid 绑定 CostMaster
UPDATE T_COST_PAGE_COMPONENT
SET REF_TABLE_CODE = 'CostMaster'
WHERE PAGE_CODE = 'cost-demo' AND COMPONENT_KEY = 'masterGrid';

-- 明细 Tabs 默认表绑定 CostDetail
UPDATE T_COST_PAGE_COMPONENT
SET REF_TABLE_CODE = 'CostDetail'
WHERE PAGE_CODE = 'cost-demo' AND COMPONENT_KEY = 'detailTabs';
```

## 多种配置情况
### 情况 A：单表 CRUD（仅主表）
- 只需配置主表 table metadata + columns + 一个 GRID 组件。

### 情况 B：主从 CRUD（多 Tab 明细）
- 配置主表 + 从表，并在 TABS componentConfig 中为不同 tab 指定 `tableCode`：
```json
{
  "mode": "multi",
  "tabs": [
    {"key":"material","title":"原料","tableCode":"CostMaterial","columns":["item","qty","cost"]},
    {"key":"package","title":"包材","tableCode":"CostPackage","columns":["item","qty","cost"]}
  ]
}
```

## 注意事项
- **临时 ID → 真实 ID** 由 `/api/data/save` 返回 `idMapping` 完成映射；前端会更新缓存。
- 从表外键字段必须与 **PARENT_FK_COLUMN** 对应，且列元数据中存在该字段（fieldName）。
- 保存锁（防重复提交）为前端内置状态，无需配置。
- 事务更新 Grid：Client-Side 使用 `applyTransaction`；SSRM 模式通常需要 `refreshServerSide` 触发刷新（详见 1.9）。

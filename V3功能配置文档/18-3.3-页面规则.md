# 3.3 页面规则（T_COST_PAGE_RULE）配置说明

## 基础字段
- PAGE_CODE / COMPONENT_KEY / RULE_TYPE / RULES / SORT_ORDER
- RULES 为 JSON 字符串（数组或对象，取决于规则类型）

## 规则类型与示例

### CALC（行级计算）
```json
[
  {"field":"costBatch","expression":"qty * price","triggerFields":["qty","price"],"order":1}
]
```

### VALIDATION（前端验证）
```json
[
  {"field":"name","required":true,"message":"名称必填"},
  {"field":"amount","min":0}
]
```

### LOOKUP（弹窗选择）
```json
[
  {"field":"materialCode","lookupCode":"MATERIAL","mapping":{"materialCode":"code","materialName":"name"}}
]
```

### COLUMN_OVERRIDE（列覆盖/扩展）
```json
[
  {"field":"amount","width":120,"editable":false,"rulesConfig":{"format":{"precision":2}}}
]
```

### AGGREGATE（聚合）
```json
[
  {"sourceField":"costBatch","targetField":"totalYl","algorithm":"SUM","filter":"dtlUseflag === '原料'"},
  {"targetField":"totalCost","expression":"totalYl + totalFl + totalBc"}
]
```

### BROADCAST（主表广播字段）
```json
["taxRate","yield"]
```

### CONTEXT_MENU（右键菜单）
```json
{"items":[{"action":"addRow"},{"action":"deleteRow","requiresRow":true}]}
```

### SUMMARY_CONFIG / NESTED_CONFIG（嵌套汇总）
```json
{
  "enabled": true,
  "groupLabelField": "groupLabel",
  "groupLabelHeader": "分类",
  "summaryColumns": [
    {"field":"total","headerName":"合计","width":120}
  ],
  "summaryAggregates": [
    {"sourceField":"costBatch","targetField":"total","algorithm":"SUM"}
  ]
}
```

### ROLE_BINDING（角色绑定）
```json
{"role":"MASTER_GRID"}
```

### RELATION（主从关系 + Split）
```json
{"masterKey":"masterGrid","detailKey":"detailTabs","detailType":"split","splitConfig":{"defaultSize":0.6}}
```

### GRID_OPTIONS / GRID_FEATURES（Grid 扩展）
```json
{"rowModelType":"serverSide","cacheBlockSize":100,"sideBar":true,"groupBy":["dept"]}
```

### ROW_EDITABLE（行级可编辑）
```json
[{"field":"status","operator":"ne","value":"已审核"}]
```

### ROW_CLASS（行级样式）
```json
[{"field":"status","operator":"eq","value":"异常","className":"row-danger"}]
```

## 示例：插入规则
```sql
INSERT INTO T_COST_PAGE_RULE (ID, PAGE_CODE, COMPONENT_KEY, RULE_TYPE, RULES, SORT_ORDER, CREATE_BY)
VALUES (SEQ_COST_PAGE_RULE.NEXTVAL, 'cost-demo', 'masterGrid', 'CALC', '[...]', 0, 'system');
```

## 注意事项
- 同一 componentKey + ruleType 多条时，系统只会读取第一条规则（按 sortOrder 排序后）。这适用于所有规则类型：AGGREGATE、CALC、VALIDATION、LOOKUP、COLUMN_OVERRIDE、CONTEXT_MENU、GRID_OPTIONS、ROLE_BINDING、RELATION、SUMMARY_CONFIG、ROW_EDITABLE、ROW_CLASS、BROADCAST 等。请确保不要重复配置同类型规则。
- RULES 为字符串时必须是合法 JSON。

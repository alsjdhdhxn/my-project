# 1.5 弹窗选择器（Lookup）配置说明

## 配置入口
1) **列 rulesConfig / 页面规则 LOOKUP**：绑定哪些字段触发 lookup
2) **T_COST_LOOKUP_CONFIG**：lookup 弹窗的字段、数据源、搜索字段

## 规则结构（LOOKUP）
```json
{
  "field": "materialCode",
  "lookupCode": "MATERIAL",
  "mapping": {
    "materialCode": "code",
    "materialName": "name",
    "unit": "unit"
  }
}
```

## 示例 A：列 rulesConfig 绑定 Lookup
```sql
INSERT INTO T_COST_PAGE_RULE (ID, PAGE_CODE, COMPONENT_KEY, RULE_TYPE, RULES, CREATE_BY)
VALUES (
  SEQ_COST_PAGE_RULE.NEXTVAL,
  'cost-demo',
  'masterGrid',
  'COLUMN_OVERRIDE',
  q'~[
    {"field":"materialCode","rulesConfig":{"lookup":{"code":"MATERIAL","mapping":{"materialCode":"code","materialName":"name"}}}}
  ]~',
  'system'
);
```

## 示例 B：页面规则 LOOKUP（主表/明细）
```sql
INSERT INTO T_COST_PAGE_RULE (ID, PAGE_CODE, COMPONENT_KEY, RULE_TYPE, RULES, CREATE_BY)
VALUES (
  SEQ_COST_PAGE_RULE.NEXTVAL,
  'cost-demo',
  'material',
  'LOOKUP',
  q'~[
    {"field":"materialCode","lookupCode":"MATERIAL","mapping":{"materialCode":"code","materialName":"name","unit":"unit"}}
  ]~',
  'system'
);
```

## 示例 C：Lookup 配置表（T_COST_LOOKUP_CONFIG）
```sql
INSERT INTO T_COST_LOOKUP_CONFIG (
  ID, LOOKUP_CODE, LOOKUP_NAME, DATA_SOURCE, DISPLAY_COLUMNS, SEARCH_COLUMNS, VALUE_FIELD, LABEL_FIELD, CREATE_BY
) VALUES (
  SEQ_COST_LOOKUP_CONFIG.NEXTVAL,
  'MATERIAL',
  '原料选择',
  'CostMaterial',
  '[{"field":"code","header":"编码","width":120},{"field":"name","header":"名称","width":200},{"field":"unit","header":"单位","width":80}]',
  '["code","name"]',
  'code',
  'name',
  'system'
);
```

## 多种配置情况
1) **dataSource 使用表名**：如 `T_COST_MATERIAL`（系统会自动转为 tableCode）。
2) **dataSource 使用 tableCode**：如 `CostMaterial`。
3) **mapping 多字段回填**：主表/明细可配置不同映射。

## 注意事项
- lookup 弹窗请求 `/api/metadata/lookup/{lookupCode}` 获取配置，再调用 `/api/data/{tableCode}?lookup=true` 拉数。
- 如果同时存在列 rulesConfig 与 LOOKUP 规则，**LOOKUP 规则优先**。
- 回填后会触发行/聚合计算（runDetailCalc / recalcAggregates）。

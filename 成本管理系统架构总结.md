# 成本管理系统架构总结

## 一、元数据架构

### 1.1 元数据驱动流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              前端请求                                                │
│  GET/POST/PUT/DELETE  /api/data/{tableCode}                                         │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         DynamicDataController (通用控制器)                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 根据 tableCode 查询 T_COST_TABLE_METADATA                                │   │
│  │ 2. 获取 QUERY_VIEW (查询用) 和 TARGET_TABLE (保存用)                        │   │
│  │ 3. 查询 T_COST_COLUMN_METADATA 获取列定义                                   │   │
│  │ 4. 使用 AnyLine 动态执行 SQL                                                │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                    ┌───────────────────┼───────────────────┐
                    ▼                   ▼                   ▼
            ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
            │ 查询操作     │     │ 新增/更新   │     │ 删除操作    │
            │ ↓           │     │ ↓           │     │ ↓           │
            │ QUERY_VIEW  │     │ TARGET_TABLE│     │ TARGET_TABLE│
            │ (视图)      │     │ (表)        │     │ (软删除)    │
            └─────────────┘     └─────────────┘     └─────────────┘
```

### 1.2 元数据表关系图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           T_COST_TABLE_METADATA                                      │
│                              (表格元数据)                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │ ID | TABLE_CODE | TABLE_NAME | QUERY_VIEW | TARGET_TABLE | SEQUENCE_NAME    │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ 1:N (TABLE_METADATA_ID)
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          T_COST_COLUMN_METADATA                                      │
│                              (列元数据)                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │ ID | TABLE_METADATA_ID | FIELD_NAME | HEADER_TEXT | DATA_TYPE | EDITABLE    │   │
│  │    | VISIBLE | REQUIRED | IS_VIRTUAL | LOOKUP_CONFIG_ID | RULES_CONFIG      │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ N:1 (LOOKUP_CONFIG_ID, 可选)
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           T_COST_LOOKUP_CONFIG                                       │
│                            (弹窗选择器配置)                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │ ID | LOOKUP_CODE | LOOKUP_NAME | DATA_SOURCE | DISPLAY_COLUMNS              │   │
│  │    | SEARCH_COLUMNS | VALUE_FIELD | LABEL_FIELD                             │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 页面组件树架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          T_COST_PAGE_COMPONENT                                       │
│                             (页面组件树)                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │ ID | PAGE_CODE | COMPONENT_KEY | COMPONENT_TYPE | PARENT_KEY                 │   │
│  │    | COMPONENT_CONFIG (JSON) | REF_METADATA_ID | SLOT_NAME | SORT_ORDER      │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                    ┌───────────────────┴───────────────────┐
                    │                                       │
                    ▼                                       ▼
        ┌─────────────────────┐                 ┌─────────────────────┐
        │   UI 组件类型        │                 │   逻辑组件类型       │
        │ ─────────────────── │                 │ ─────────────────── │
        │ • GRID (数据表格)    │                 │ • LOGIC_STATE_LOCK  │
        │ • FORM (动态表单)    │                 │ • LOGIC_WORKFLOW    │
        │ • BUTTON (操作按钮)  │                 │ • LOGIC_AGG         │
        │ • LAYOUT (布局容器)  │                 │ • LOGIC_FIELD       │
        └─────────────────────┘                 │ • LOGIC_MAPPING     │
                                                └─────────────────────┘
```

---

## 三、计算架构（三层计算模型）

### 3.1 计算层次划分

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              三层计算模型                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  第一层: 行级计算 (Row-Level)                                                │   │
│  │  ─────────────────────────────────────────────────────────────────────────  │   │
│  │  配置位置: T_COST_COLUMN_METADATA.RULES_CONFIG                              │   │
│  │  执行位置: 前端 (当前行数据变化时触发)                                        │   │
│  │  典型场景: 金额 = 数量 × 单价                                                │   │
│  │  作用范围: 单行内字段之间的计算                                               │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        │ 触发                                       │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  第二层: 聚合计算 (Aggregation)                                              │   │
│  │  ─────────────────────────────────────────────────────────────────────────  │   │
│  │  配置位置: T_COST_PAGE_COMPONENT (LOGIC_AGG 组件)                           │   │
│  │  执行位置: 前端 LogicEngine (监听源组件 DataChange 事件)                     │   │
│  │  典型场景: 主表.总金额 = SUM(从表.金额)                                      │   │
│  │  作用范围: 跨组件（从表 Grid → 主表 Form）                                   │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        │ 触发                                       │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  第三层: 级联计算 (Cascade)                                                  │   │
│  │  ─────────────────────────────────────────────────────────────────────────  │   │
│  │  配置位置: T_COST_COLUMN_METADATA.RULES_CONFIG (主表列)                      │   │
│  │  执行位置: 前端 (聚合结果写入后，触发主表行级计算)                            │   │
│  │  典型场景: 主表.税额 = 主表.总金额 × 税率                                    │   │
│  │  作用范围: 主表内字段之间的计算（依赖聚合结果）                               │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 计算链路示例（多米诺效应）

```
用户修改从表某行的"数量"
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  第一层: 行级计算                                                                    │
│  ─────────────────────────────────────────────────────────────────────────────────  │
│  配置来源: T_COST_COLUMN_METADATA.RULES_CONFIG                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │ {                                                                             │ │
│  │   "calculate": {                                                              │ │
│  │     "expression": "quantity * unitPrice",                                     │ │
│  │     "triggerFields": ["quantity", "unitPrice"]                                │ │
│  │   }                                                                           │ │
│  │ }                                                                             │ │
│  └───────────────────────────────────────────────────────────────────────────────┘ │
│  执行结果: 从表当前行.amount = 数量 × 单价                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘
        │
        │ Grid 数据变化，触发 DataChange 事件
        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  第二层: 聚合计算                                                                    │
│  ─────────────────────────────────────────────────────────────────────────────────  │
│  配置来源: T_COST_PAGE_COMPONENT (LOGIC_AGG 组件)                                   │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │ COMPONENT_CONFIG = {                                                          │ │
│  │   "sourceComponent": "detailGrid",                                            │ │
│  │   "sourceField": "amount",                                                    │ │
│  │   "targetComponent": "masterForm",                                            │ │
│  │   "targetField": "totalAmount",                                               │ │
│  │   "algorithm": "SUM"                                                          │ │
│  │ }                                                                             │ │
│  └───────────────────────────────────────────────────────────────────────────────┘ │
│  执行结果: 主表.totalAmount = SUM(所有从表行.amount)                                │
└─────────────────────────────────────────────────────────────────────────────────────┘
        │
        │ 主表字段变化，触发主表行级计算
        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  第三层: 级联计算                                                                    │
│  ─────────────────────────────────────────────────────────────────────────────────  │
│  配置来源: T_COST_COLUMN_METADATA.RULES_CONFIG (主表的 taxAmount 列)                │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │ {                                                                             │ │
│  │   "calculate": {                                                              │ │
│  │     "expression": "totalAmount * taxRate",                                    │ │
│  │     "triggerFields": ["totalAmount", "taxRate"]                               │ │
│  │   }                                                                           │ │
│  │ }                                                                             │ │
│  └───────────────────────────────────────────────────────────────────────────────┘ │
│  执行结果: 主表.taxAmount = 主表.totalAmount × 税率                                 │
└─────────────────────────────────────────────────────────────────────────────────────┘
        │
        ▼
    计算完成
```

### 3.3 配置位置对照表

| 计算类型 | 配置表 | 配置字段 | 执行位置 | 触发时机 |
|---------|-------|---------|---------|---------|
| **行级计算** | T_COST_COLUMN_METADATA | RULES_CONFIG.calculate | 前端 Grid/Form | 当前行字段变化 |
| **聚合计算** | T_COST_PAGE_COMPONENT | COMPONENT_CONFIG (LOGIC_AGG) | 前端 LogicEngine | 源组件 DataChange |
| **级联计算** | T_COST_COLUMN_METADATA | RULES_CONFIG.calculate | 前端 Grid/Form | 聚合结果写入后 |
| **字段依赖** | T_COST_PAGE_COMPONENT | COMPONENT_CONFIG (LOGIC_FIELD) | 前端 LogicEngine | 依赖字段变化 |
| **数据映射** | T_COST_PAGE_COMPONENT | COMPONENT_CONFIG (LOGIC_MAPPING) | 前端 LogicEngine | Lookup 选择后 |

### 3.4 逻辑组件类型说明

| 组件类型 | 用途 | COMPONENT_CONFIG 示例 |
|---------|------|----------------------|
| **LOGIC_AGG** | 跨组件聚合计算 | `{"sourceComponent":"grid1","sourceField":"amount","targetComponent":"form1","targetField":"total","algorithm":"SUM"}` |
| **LOGIC_FIELD** | 字段联动（显隐/必填/只读） | `{"dependency":"status","target":"approveDate","behavior":"VISIBLE","expression":"val=='APPROVED'"}` |
| **LOGIC_MAPPING** | 数据回填（Lookup选择后） | `{"sourceType":"LOOKUP","sourceKey":"productLookup","fieldMapping":{"productCode":"code","productName":"name"}}` |
| **LOGIC_STATE_LOCK** | 状态锁定（审批中禁止编辑） | `{"triggerField":"status","lockCondition":"['APPROVING','DONE'].includes(val)","targetScope":"PARENT"}` |
| **LOGIC_WORKFLOW** | 流程挂载 | `{"processCode":"COST_FLOW","businessIdField":"id","statusField":"status"}` |

### 3.5 前端 LogicEngine 执行流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           前端 LogicEngine 架构                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   页面加载                                                                          │
│       │                                                                             │
│       ▼                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │  1. 加载 T_COST_PAGE_COMPONENT 配置                                         │  │
│   │  2. 筛选出所有 LOGIC_xxx 类型组件                                           │  │
│   │  3. 建立响应式监听 (watch)                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│       │                                                                             │
│       ▼                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │  数据变化时:                                                                 │  │
│   │  ┌───────────────────────────────────────────────────────────────────────┐  │  │
│   │  │  for each LOGIC_AGG:                                                  │  │  │
│   │  │    1. 读取 sourceComponent 的数据                                     │  │  │
│   │  │    2. 执行聚合算法 (SUM/AVG/COUNT/MAX/MIN)                            │  │  │
│   │  │    3. 将结果写入 targetComponent.targetField                          │  │  │
│   │  │    4. 写入操作触发 targetComponent 的行级计算 (级联)                   │  │  │
│   │  └───────────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、权限架构

### 2.1 四层权限模型流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              用户登录                                                │
│                                 │                                                   │
│                                 ▼                                                   │
│                    ┌─────────────────────────┐                                      │
│                    │    T_COST_USER          │                                      │
│                    │    (用户表)             │                                      │
│                    └───────────┬─────────────┘                                      │
│                                │                                                    │
│                                │ N:N (通过 T_COST_USER_ROLE)                        │
│                                ▼                                                    │
│                    ┌─────────────────────────┐                                      │
│                    │    T_COST_ROLE          │                                      │
│                    │    (角色表)             │                                      │
│                    └───────────┬─────────────┘                                      │
│                                │                                                    │
│                                │ 1:N                                                │
│                                ▼                                                    │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                       T_COST_ROLE_PAGE                                        │  │
│  │                      (角色页面权限表)                                          │  │
│  │  ┌────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  第一层: 页面权限     → PAGE_CODE (能否访问该页面)                       │  │  │
│  │  │  第二层: 按钮权限     → BUTTON_POLICY (JSON: ["CREATE","EDIT","DELETE"]) │  │  │
│  │  │  第三层: 列权限       → COLUMN_POLICY (JSON: 列级可见/可编辑控制)        │  │  │
│  │  └────────────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                │                                                    │
│                                │ 1:N                                                │
│                                ▼                                                    │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                    T_COST_ROLE_PAGE_DATA_RULE                                 │  │
│  │                        (数据权限规则表)                                        │  │
│  │  ┌────────────────────────────────────────────────────────────────────────┐  │  │
│  │  │  第四层: 数据权限     → RULE_TYPE + RULE_CONFIG (行级数据过滤)           │  │  │
│  │  └────────────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 权限表关系图

```
┌───────────────┐         ┌───────────────────┐         ┌───────────────┐
│ T_COST_USER   │ ──N:N── │ T_COST_USER_ROLE  │ ──N:1── │ T_COST_ROLE   │
│ (用户表)      │         │ (用户角色关联)     │         │ (角色表)      │
└───────────────┘         └───────────────────┘         └───────┬───────┘
                                                                │
                                                                │ 1:N
                                                                ▼
                                                    ┌───────────────────────┐
                                                    │   T_COST_ROLE_PAGE    │
                                                    │  (角色页面权限)        │
                                                    │ ───────────────────── │
                                                    │ • PAGE_CODE           │
                                                    │ • BUTTON_POLICY (JSON)│
                                                    │ • COLUMN_POLICY (JSON)│
                                                    └───────────┬───────────┘
                                                                │
                                                                │ 1:N
                                                                ▼
                                                    ┌───────────────────────┐
                                                    │T_COST_ROLE_PAGE_DATA  │
                                                    │      _RULE            │
                                                    │  (数据权限规则)        │
                                                    │ ───────────────────── │
                                                    │ • RULE_TYPE           │
                                                    │ • RULE_CONFIG (JSON)  │
                                                    │ • PRIORITY            │
                                                    └───────────────────────┘
```

### 2.3 权限合并流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            权限配置合并流程                                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────┐                                                               │
│   │ T_COST_COLUMN   │  ← 基础层 (Base): 定义字段的默认属性                           │
│   │   _METADATA     │     visible, editable, required 等                            │
│   └────────┬────────┘                                                               │
│            │                                                                        │
│            ▼                                                                        │
│   ┌─────────────────┐                                                               │
│   │ T_COST_ROLE     │  ← 限制层 (Restriction): 企业级安全管控                        │
│   │   _PAGE         │     COLUMN_POLICY JSON 只能收紧权限，不能放宽                  │
│   │ (COLUMN_POLICY) │     例: 角色禁止看 costPrice，则该角色用户都看不到              │
│   └────────┬────────┘                                                               │
│            │                                                                        │
│            ▼                                                                        │
│   ┌─────────────────┐                                                               │
│   │ T_COST_USER     │  ← 偏好层 (Preference): 用户个性化设置                         │
│   │ _GRID_CONFIG    │     只能在允许范围内调整 UI (宽度、排序、隐藏)                  │
│   │ (CONFIG_DATA)   │     不能突破角色限制                                           │
│   └────────┬────────┘                                                               │
│            │                                                                        │
│            ▼                                                                        │
│   ┌─────────────────┐                                                               │
│   │   最终配置       │  ← 合并结果: 在后端 PermissionService 中内存合并               │
│   │  (Final Config) │                                                               │
│   └─────────────────┘                                                               │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、表职责说明

### 4.1 元数据相关表

| 表名 | 职责 | 关联关系 |
|------|------|---------|
| T_COST_TABLE_METADATA | 定义业务表的基本信息：编码、名称、查询视图、保存表、序列名 | 被 COLUMN_METADATA 引用 |
| T_COST_COLUMN_METADATA | 定义表格列的属性：字段名、标题、类型、宽度、是否可编辑/可见/必填、行级计算规则 | 引用 TABLE_METADATA、LOOKUP_CONFIG |
| T_COST_LOOKUP_CONFIG | 定义弹窗选择器：数据源、显示列、搜索列、值字段 | 被 COLUMN_METADATA 引用 |
| T_COST_PAGE_COMPONENT | 定义页面组件树：组件类型、父子关系、配置JSON、关联元数据 | 自引用(PARENT_KEY)、引用 TABLE_METADATA |

### 4.2 权限相关表

| 表名 | 职责 | 关联关系 |
|------|------|---------|
| T_COST_USER | 用户基本信息 | 被 USER_ROLE 引用，引用 DEPARTMENT |
| T_COST_ROLE | 角色定义 | 被 USER_ROLE、ROLE_PAGE 引用 |
| T_COST_USER_ROLE | 用户-角色多对多关联 | 引用 USER、ROLE |
| T_COST_ROLE_PAGE | 角色页面权限：页面访问、按钮权限(JSON)、列权限(JSON) | 引用 ROLE，被 DATA_RULE 引用 |
| T_COST_ROLE_PAGE_DATA_RULE | 数据权限规则：行级数据过滤条件 | 引用 ROLE_PAGE |
| T_COST_USER_GRID_CONFIG | 用户个人偏好：列宽、排序、固定、隐藏等 | 引用 USER |
| T_COST_RESOURCE | 菜单资源：目录和页面入口（纯导航，不含按钮） | 自引用(PARENT_ID)，PAGE_CODE 关联 PAGE_COMPONENT |

> **注意**：`T_COST_RESOURCE` 只管菜单导航，按钮权限在 `T_COST_ROLE_PAGE.BUTTON_POLICY` 中配置，页面内部结构在 `T_COST_PAGE_COMPONENT

### 4.3 基础数据表

| 表名 | 职责 | 关联关系 |
|------|------|---------|
| T_COST_DEPARTMENT | 部门/组织架构 | 自引用(PARENT_ID)，被 USER 引用 |
| T_COST_DICTIONARY_TYPE | 字典类型定义 | 被 DICTIONARY_ITEM 引用 |
| T_COST_DICTIONARY_ITEM | 字典项（下拉选项） | 引用 DICTIONARY_TYPE |

### 4.4 日志与通知表

| 表名 | 职责 | 关联关系 |
|------|------|---------|
| T_COST_SQL_AUDIT_LOG | SQL操作审计日志 | 引用 USER（操作人） |
| T_COST_NOTIFICATION | 消息通知（SSE推送） | 引用 USER（接收人） |

### 4.5 工作流表

| 表名 | 职责 | 关联关系 |
|------|------|---------|
| T_COST_PROCESS_DEFINITION | 流程定义（节点、连线配置） | 被 PROCESS_INSTANCE 引用 |
| T_COST_PROCESS_INSTANCE | 流程实例（运行中的流程） | 引用 PROCESS_DEFINITION，被 TASK/HISTORY 引用 |
| T_COST_PROCESS_TASK | 待办任务 | 引用 PROCESS_INSTANCE |
| T_COST_PROCESS_HISTORY | 审批历史记录 | 引用 PROCESS_INSTANCE、TASK |

---

## 五、完整表结构

### 5.1 元数据表

```sql
-- 表格元数据
CREATE TABLE T_COST_TABLE_METADATA (
    ID              NUMBER(19) PRIMARY KEY,
    TABLE_CODE      VARCHAR2(50) NOT NULL,   -- 表格编码（大驼峰，如 CostMaster）
    TABLE_NAME      VARCHAR2(100) NOT NULL,  -- 表格显示名称
    QUERY_VIEW      VARCHAR2(100),           -- 查询视图名（如 V_COST_MASTER）
    TARGET_TABLE    VARCHAR2(100),           -- 保存表名（如 T_COST_MASTER）
    SEQUENCE_NAME   VARCHAR2(100),           -- 序列名（如 SEQ_COST_MASTER）
    AUDIT_ENABLED   NUMBER(1) DEFAULT 0,     -- 是否启用审计日志：0-否，1-是
    DESCRIPTION     VARCHAR2(500),
    ENABLED         NUMBER(1) DEFAULT 1,
    CREATE_BY       NUMBER(19),
    CREATE_TIME     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATE_BY       NUMBER(19),
    UPDATE_TIME     TIMESTAMP
);
CREATE UNIQUE INDEX UK_TABLE_METADATA_CODE ON T_COST_TABLE_METADATA(TABLE_CODE);

-- 列元数据
CREATE TABLE T_COST_COLUMN_METADATA (
    ID                  NUMBER(19) PRIMARY KEY,
    TABLE_METADATA_ID   NUMBER(19) NOT NULL,     -- 关联表格元数据
    FIELD_NAME          VARCHAR2(50) NOT NULL,   -- 字段名（小驼峰）
    HEADER_TEXT         VARCHAR2(100) NOT NULL,  -- 列标题
    DATA_TYPE           VARCHAR2(20) NOT NULL,   -- 数据类型
    WIDTH               NUMBER(5) DEFAULT 120,
    SORTABLE            NUMBER(1) DEFAULT 1,
    FILTERABLE          NUMBER(1) DEFAULT 1,
    EDITABLE            NUMBER(1) DEFAULT 0,
    VISIBLE             NUMBER(1) DEFAULT 1,
    REQUIRED            NUMBER(1) DEFAULT 0,
    IS_VIRTUAL          NUMBER(1) DEFAULT 0,     -- 是否虚拟列（计算列）
    LOOKUP_CONFIG_ID    NUMBER(19),              -- 弹窗选择器配置ID
    RULES_CONFIG        CLOB,                    -- 列规则配置（JSON）
    SORT_ORDER          NUMBER(5) DEFAULT 0,
    ENABLED             NUMBER(1) DEFAULT 1,
    CREATE_BY           NUMBER(19),
    CREATE_TIME         TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IDX_COLUMN_TABLE_ID ON T_COST_COLUMN_METADATA(TABLE_METADATA_ID);

-- 弹窗选择器配置
CREATE TABLE T_COST_LOOKUP_CONFIG (
    ID              NUMBER(19) PRIMARY KEY,
    LOOKUP_CODE     VARCHAR2(50) NOT NULL,
    LOOKUP_NAME     VARCHAR2(100) NOT NULL,
    DATA_SOURCE     VARCHAR2(200) NOT NULL,  -- 数据源 API
    DISPLAY_COLUMNS CLOB,                    -- 显示列 JSON
    SEARCH_COLUMNS  CLOB,                    -- 搜索列 JSON
    VALUE_FIELD     VARCHAR2(50) NOT NULL,
    LABEL_FIELD     VARCHAR2(50) NOT NULL,
    ENABLED         NUMBER(1) DEFAULT 1
);

-- 页面组件树
CREATE TABLE T_COST_PAGE_COMPONENT (
    ID              NUMBER(19) PRIMARY KEY,
    PAGE_CODE       VARCHAR2(50) NOT NULL,   -- 所属页面
    COMPONENT_KEY   VARCHAR2(50) NOT NULL,   -- 组件唯一Key
    COMPONENT_TYPE  VARCHAR2(20) NOT NULL,   -- 组件类型
    PARENT_KEY      VARCHAR2(50),            -- 父组件Key
    COMPONENT_CONFIG CLOB,                   -- 组件配置（JSON）
    REF_METADATA_ID NUMBER(19),              -- 关联引用ID
    SLOT_NAME       VARCHAR2(20),
    SORT_ORDER      NUMBER(5) DEFAULT 0,
    ENABLED         NUMBER(1) DEFAULT 1,
    DESCRIPTION     VARCHAR2(200)
);
CREATE INDEX IDX_PAGE_COMP_PAGE ON T_COST_PAGE_COMPONENT(PAGE_CODE);
```

### 5.2 权限表

```sql
-- 用户表
CREATE TABLE T_COST_USER (
    ID              NUMBER(19) PRIMARY KEY,
    USERNAME        VARCHAR2(50) NOT NULL,
    PASSWORD        VARCHAR2(200) NOT NULL,
    REAL_NAME       VARCHAR2(100),
    EMAIL           VARCHAR2(100),
    PHONE           VARCHAR2(20),
    DEPARTMENT_ID   NUMBER(19),
    STATUS          VARCHAR2(20) DEFAULT 'ACTIVE',
    ENABLED         NUMBER(1) DEFAULT 1,
    CREATE_BY       NUMBER(19),
    CREATE_TIME     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATE_BY       NUMBER(19),
    UPDATE_TIME     TIMESTAMP
);
CREATE UNIQUE INDEX UK_USER_USERNAME ON T_COST_USER(USERNAME);

-- 角色表
CREATE TABLE T_COST_ROLE (
    ID              NUMBER(19) PRIMARY KEY,
    ROLE_CODE       VARCHAR2(50) NOT NULL,
    ROLE_NAME       VARCHAR2(100) NOT NULL,
    DESCRIPTION     VARCHAR2(500),
    ENABLED         NUMBER(1) DEFAULT 1,
    CREATE_BY       NUMBER(19),
    CREATE_TIME     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATE_BY       NUMBER(19),
    UPDATE_TIME     TIMESTAMP
);
CREATE UNIQUE INDEX UK_ROLE_CODE ON T_COST_ROLE(ROLE_CODE);

-- 用户角色关联表
CREATE TABLE T_COST_USER_ROLE (
    ID              NUMBER(19) PRIMARY KEY,
    USER_ID         NUMBER(19) NOT NULL,
    ROLE_ID         NUMBER(19) NOT NULL,
    CONSTRAINT FK_UR_USER FOREIGN KEY (USER_ID) REFERENCES T_COST_USER(ID),
    CONSTRAINT FK_UR_ROLE FOREIGN KEY (ROLE_ID) REFERENCES T_COST_ROLE(ID)
);
CREATE UNIQUE INDEX UK_USER_ROLE ON T_COST_USER_ROLE(USER_ID, ROLE_ID);

-- 资源表
CREATE TABLE T_COST_RESOURCE (
    ID              NUMBER(19) PRIMARY KEY,
    RESOURCE_CODE   VARCHAR2(50) NOT NULL,
    RESOURCE_NAME   VARCHAR2(100) NOT NULL,
    RESOURCE_TYPE   VARCHAR2(20) NOT NULL,   -- DIRECTORY, PAGE, BUTTON
    PARENT_ID       NUMBER(19),
    SORT_ORDER      NUMBER(5) DEFAULT 0,
    ENABLED         NUMBER(1) DEFAULT 1
);

-- 角色页面权限表（含按钮权限、列权限）
CREATE TABLE T_COST_ROLE_PAGE (
    ID              NUMBER(19) PRIMARY KEY,
    ROLE_ID         NUMBER(19) NOT NULL,
    PAGE_CODE       VARCHAR2(50) NOT NULL,
    BUTTON_POLICY   VARCHAR2(1000),          -- 按钮权限 JSON: ["CREATE","EDIT","DELETE"]
    COLUMN_POLICY   CLOB,                    -- 列权限 JSON: {"costPrice":{"visible":false}}
    ENABLED         NUMBER(1) DEFAULT 1,
    CREATE_TIME     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATE_TIME     TIMESTAMP,
    CONSTRAINT FK_ROLE_PAGE_ROLE FOREIGN KEY (ROLE_ID) REFERENCES T_COST_ROLE(ID)
);
CREATE UNIQUE INDEX UK_ROLE_PAGE ON T_COST_ROLE_PAGE(ROLE_ID, PAGE_CODE);

-- 数据权限规则表
CREATE TABLE T_COST_ROLE_PAGE_DATA_RULE (
    ID              NUMBER(19) PRIMARY KEY,
    ROLE_PAGE_ID    NUMBER(19) NOT NULL,
    RULE_TYPE       VARCHAR2(20) NOT NULL,   -- DEPARTMENT, USER, EXPRESSION
    RULE_CONFIG     CLOB NOT NULL,           -- 规则配置 JSON
    PRIORITY        NUMBER(3) DEFAULT 0,
    CONSTRAINT FK_DATA_RULE_RP FOREIGN KEY (ROLE_PAGE_ID) REFERENCES T_COST_ROLE_PAGE(ID)
);

-- 用户网格配置表（个人偏好）
CREATE TABLE T_COST_USER_GRID_CONFIG (
    ID              NUMBER(19) PRIMARY KEY,
    USER_ID         NUMBER(19) NOT NULL,
    PAGE_CODE       VARCHAR2(50) NOT NULL,
    GRID_KEY        VARCHAR2(50) NOT NULL,
    CONFIG_DATA     CLOB,                    -- 偏好配置 JSON
    UPDATE_TIME     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_USER_CONF_USER FOREIGN KEY (USER_ID) REFERENCES T_COST_USER(ID)
);
CREATE UNIQUE INDEX UK_USER_GRID_CONF ON T_COST_USER_GRID_CONFIG(USER_ID, PAGE_CODE, GRID_KEY);
```

### 5.3 基础数据表

```sql
-- 部门表
CREATE TABLE T_COST_DEPARTMENT (
    ID              NUMBER(19) PRIMARY KEY,
    DEPT_CODE       VARCHAR2(50) NOT NULL,
    DEPT_NAME       VARCHAR2(100) NOT NULL,
    PARENT_ID       NUMBER(19),              -- 上级部门ID
    SORT_ORDER      NUMBER(5) DEFAULT 0,
    ENABLED         NUMBER(1) DEFAULT 1,
    CREATE_BY       NUMBER(19),
    CREATE_TIME     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATE_BY       NUMBER(19),
    UPDATE_TIME     TIMESTAMP
);
CREATE UNIQUE INDEX UK_DEPT_CODE ON T_COST_DEPARTMENT(DEPT_CODE);

-- 字典类型表
CREATE TABLE T_COST_DICTIONARY_TYPE (
    ID              NUMBER(19) PRIMARY KEY,
    TYPE_CODE       VARCHAR2(50) NOT NULL,
    TYPE_NAME       VARCHAR2(100) NOT NULL,
    DESCRIPTION     VARCHAR2(500),
    ENABLED         NUMBER(1) DEFAULT 1,
    CREATE_BY       NUMBER(19),
    CREATE_TIME     TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE UNIQUE INDEX UK_DICT_TYPE_CODE ON T_COST_DICTIONARY_TYPE(TYPE_CODE);

-- 字典项表
CREATE TABLE T_COST_DICTIONARY_ITEM (
    ID              NUMBER(19) PRIMARY KEY,
    TYPE_ID         NUMBER(19) NOT NULL,
    ITEM_CODE       VARCHAR2(50) NOT NULL,
    ITEM_NAME       VARCHAR2(100) NOT NULL,
    ITEM_VALUE      VARCHAR2(200),
    SORT_ORDER      NUMBER(5) DEFAULT 0,
    EXTRA_CONFIG    VARCHAR2(1000),          -- JSON: {"color": "#67C23A", "icon": "check"}
    ENABLED         NUMBER(1) DEFAULT 1,
    CONSTRAINT FK_DICT_ITEM_TYPE FOREIGN KEY (TYPE_ID) REFERENCES T_COST_DICTIONARY_TYPE(ID)
);
CREATE INDEX IDX_DICT_ITEM_TYPE ON T_COST_DICTIONARY_ITEM(TYPE_ID);
```

---

## 六、JSON 配置字段汇总

系统中大量使用 JSON 存储复杂配置，以下是各字段的详细说明和示例。

### 6.1 T_COST_COLUMN_METADATA.RULES_CONFIG

**用途**：列级规则配置（行内计算、格式化、校验、条件控制）

```json
{
  "calculate": {
    "expression": "quantity * unitPrice",
    "triggerFields": ["quantity", "unitPrice"]
  },
  "format": {
    "decimals": 2,
    "prefix": "¥",
    "suffix": "",
    "thousandSeparator": true
  },
  "validation": {
    "min": 0,
    "max": 999999,
    "pattern": "^[A-Z]{2}\\d{6}$",
    "message": "格式必须为2位大写字母+6位数字"
  },
  "conditions": {
    "visibleWhen": "status != 'DRAFT'",
    "editableWhen": "status == 'DRAFT'",
    "requiredWhen": "type == 'PURCHASE'"
  }
}
```

| 属性 | 说明 |
|------|------|
| calculate.expression | 计算表达式，使用 expr-eval 解析 |
| calculate.triggerFields | 触发计算的字段列表 |
| format.decimals | 小数位数 |
| format.prefix/suffix | 前缀/后缀 |
| validation.min/max | 数值范围 |
| validation.pattern | 正则校验 |
| conditions.visibleWhen | 可见条件表达式 |
| conditions.editableWhen | 可编辑条件表达式 |
| conditions.requiredWhen | 必填条件表达式 |

### 6.2 T_COST_LOOKUP_CONFIG.DISPLAY_COLUMNS

**用途**：弹窗选择器显示哪些列

```json
[
  { "field": "productCode", "header": "产品编码", "width": 120 },
  { "field": "productName", "header": "产品名称", "width": 200 },
  { "field": "spec", "header": "规格型号", "width": 150 },
  { "field": "unit", "header": "单位", "width": 80 },
  { "field": "price", "header": "单价", "width": 100, "type": "number" }
]
```

### 6.3 T_COST_LOOKUP_CONFIG.SEARCH_COLUMNS

**用途**：弹窗选择器可搜索的字段

```json
[
  { "field": "productCode", "label": "产品编码", "type": "text", "operator": "like" },
  { "field": "productName", "label": "产品名称", "type": "text", "operator": "like" },
  { "field": "categoryId", "label": "产品分类", "type": "select", "operator": "eq", "dictType": "PRODUCT_CATEGORY" }
]
```

### 6.4 T_COST_PAGE_COMPONENT.COMPONENT_CONFIG

**用途**：组件配置，根据 COMPONENT_TYPE 不同，JSON 结构不同

#### 6.4.1 GRID 组件

```json
{
  "tableCode": "CostRawMaterial",
  "pageSize": 50,
  "allowEdit": true,
  "showCheckbox": true,
  "showRowNumber": true,
  "enableExport": true,
  "defaultSort": { "field": "createTime", "order": "desc" }
}
```

#### 6.4.2 FORM 组件

```json
{
  "tableCode": "CostMaster",
  "columns": 2,
  "labelWidth": 120,
  "labelPosition": "right",
  "size": "default"
}
```

#### 6.4.3 BUTTON 组件

```json
{
  "label": "提交审批",
  "icon": "i-carbon-send",
  "type": "primary",
  "actionType": "WORKFLOW",
  "actionConfig": {
    "processCode": "COST_APPROVAL",
    "confirmMessage": "确认提交审批？"
  },
  "enableExpression": "ctx.row.status == 'DRAFT'",
  "visibleExpression": "ctx.hasPermission('SUBMIT')"
}
```

#### 6.4.4 LAYOUT 组件

```json
{
  "direction": "ROW",
  "gap": 16,
  "wrap": false,
  "padding": "16px",
  "justify": "flex-start",
  "align": "stretch"
}
```

#### 6.4.5 LOGIC_AGG 组件（聚合计算）

```json
{
  "sourceComponent": "materialGrid",
  "sourceField": "amount",
  "targetComponent": "masterForm",
  "targetField": "totalMaterialCost",
  "algorithm": "SUM"
}
```

| algorithm | 说明 |
|-----------|------|
| SUM | 求和 |
| AVG | 平均值 |
| COUNT | 计数 |
| MAX | 最大值 |
| MIN | 最小值 |

#### 6.4.6 LOGIC_FIELD 组件（字段联动）

```json
{
  "dependency": "costType",
  "target": "taxRate",
  "behavior": "VALUE",
  "expression": "costType == 'IMPORT' ? 0.13 : 0.06"
}
```

| behavior | 说明 |
|----------|------|
| VISIBLE | 控制显隐 |
| REQUIRED | 控制必填 |
| READONLY | 控制只读 |
| VALUE | 设置值 |

#### 6.4.7 LOGIC_MAPPING 组件（数据回填）

```json
{
  "sourceType": "LOOKUP",
  "sourceKey": "productLookup",
  "fieldMapping": {
    "productCode": "code",
    "productName": "name",
    "spec": "specification",
    "unit": "unit",
    "unitPrice": "price"
  }
}
```

#### 6.4.8 LOGIC_STATE_LOCK 组件（状态锁定）

```json
{
  "triggerField": "status",
  "lockCondition": "['APPROVING', 'APPROVED', 'COMPLETED'].includes(val)",
  "targetScope": "PARENT",
  "excludeFields": ["remark"]
}
```

| targetScope | 说明 |
|-------------|------|
| PARENT | 锁定父组件 |
| GLOBAL | 锁定整个页面 |
| SPECIFIC | 锁定指定组件 |

#### 6.4.9 LOGIC_WORKFLOW 组件（流程挂载）

```json
{
  "processCode": "COST_APPROVAL_FLOW",
  "businessIdField": "id",
  "statusField": "status",
  "statusMapping": {
    "RUNNING": "APPROVING",
    "COMPLETED": "APPROVED",
    "REJECTED": "REJECTED"
  },
  "buttons": {
    "submit": { "label": "提交", "showWhen": "DRAFT" },
    "approve": { "label": "同意", "showWhen": "APPROVING" },
    "reject": { "label": "驳回", "showWhen": "APPROVING" },
    "revoke": { "label": "撤回", "showWhen": "APPROVING" }
  }
}
```

### 6.5 T_COST_ROLE_PAGE.BUTTON_POLICY

**用途**：角色在该页面可用的按钮权限

```json
["CREATE", "EDIT", "DELETE", "SUBMIT", "EXPORT", "IMPORT"]
```

| 权限码 | 说明 |
|--------|------|
| CREATE | 新增 |
| EDIT | 编辑 |
| DELETE | 删除 |
| SUBMIT | 提交 |
| APPROVE | 审批 |
| EXPORT | 导出 |
| IMPORT | 导入 |
| PRINT | 打印 |

### 6.6 T_COST_ROLE_PAGE.COLUMN_POLICY

**用途**：角色对列的权限控制（只能收紧，不能放宽）

```json
{
  "costPrice": { "visible": false },
  "profitRate": { "visible": false },
  "supplierContact": { "visible": true, "editable": false },
  "approvalAmount": { "editable": false }
}
```

### 6.7 T_COST_ROLE_PAGE_DATA_RULE.RULE_CONFIG

**用途**：数据权限规则（行级过滤）

#### 简单条件

```json
{
  "filterField": "CREATE_BY",
  "operator": "EQ",
  "valueSource": "CURRENT_USER_ID"
}
```

#### 部门过滤

```json
{
  "filterField": "DEPARTMENT_ID",
  "operator": "IN",
  "valueSource": "CURRENT_USER_DEPT_TREE"
}
```

#### 多条件组合

```json
{
  "conditions": [
    { "filterField": "DEPARTMENT_ID", "operator": "EQ", "valueSource": "CURRENT_USER_DEPT_ID" },
    { "filterField": "STATUS", "operator": "NE", "value": "DELETED" }
  ],
  "logic": "AND"
}
```

#### 自定义表达式

```json
{
  "expression": "(CREATE_BY = #{currentUserId} OR DEPARTMENT_ID = #{currentDeptId})",
  "description": "自己创建的或本部门的数据"
}
```

| operator | 说明 | 生成SQL |
|----------|------|---------|
| EQ | 等于 | = |
| NE | 不等于 | != |
| GT | 大于 | > |
| GE | 大于等于 | >= |
| LT | 小于 | < |
| LE | 小于等于 | <= |
| IN | 包含 | IN (...) |
| LIKE | 模糊 | LIKE |

| valueSource | 说明 |
|-------------|------|
| CURRENT_USER_ID | 当前用户ID |
| CURRENT_USER_DEPT_ID | 当前用户部门ID |
| CURRENT_USER_DEPT_TREE | 当前用户部门及下级部门ID列表 |

### 6.8 T_COST_USER_GRID_CONFIG.CONFIG_DATA

**用途**：用户个人的表格偏好设置

```json
{
  "productCode": { "width": 150, "pinned": "left", "visible": true },
  "productName": { "width": 250, "pinned": null, "visible": true },
  "createTime": { "width": 180, "pinned": null, "visible": false },
  "columnOrder": ["productCode", "productName", "quantity", "unitPrice", "amount"],
  "sortModel": [{ "colId": "createTime", "sort": "desc" }],
  "filterModel": {
    "status": { "filterType": "set", "values": ["DRAFT", "SUBMITTED"] }
  }
}
```

### 6.9 T_COST_PROCESS_DEFINITION.PROCESS_CONFIG

**用途**：审批流程定义（节点、连线）

```json
{
  "nodes": [
    { "id": "start", "type": "START", "name": "开始" },
    {
      "id": "approve1",
      "type": "APPROVAL",
      "name": "部门经理审批",
      "config": {
        "approverType": "ROLE",
        "approverValue": "DEPT_MANAGER",
        "multiApprove": "ANY"
      }
    },
    {
      "id": "condition1",
      "type": "CONDITION",
      "name": "金额判断",
      "config": {
        "conditions": [
          { "expression": "amount > 10000", "targetNodeId": "approve2" },
          { "expression": "amount <= 10000", "targetNodeId": "end" }
        ]
      }
    },
    {
      "id": "approve2",
      "type": "APPROVAL",
      "name": "财务总监审批",
      "config": { "approverType": "USER", "approverValue": "1001", "multiApprove": "ALL" }
    },
    { "id": "end", "type": "END", "name": "结束" }
  ],
  "edges": [
    { "from": "start", "to": "approve1" },
    { "from": "approve1", "to": "condition1" },
    { "from": "condition1", "to": "approve2", "label": "金额>1万" },
    { "from": "condition1", "to": "end", "label": "金额≤1万" },
    { "from": "approve2", "to": "end" }
  ]
}
```

| 节点类型 | 说明 |
|----------|------|
| START | 开始节点 |
| END | 结束节点 |
| APPROVAL | 审批节点 |
| CC | 抄送节点 |
| CONDITION | 条件分支节点 |

| approverType | 说明 |
|--------------|------|
| USER | 指定用户 |
| ROLE | 指定角色 |
| DEPARTMENT | 指定部门 |
| EXPRESSION | 表达式动态计算 |

| multiApprove | 说明 |
|--------------|------|
| ANY | 任一人通过即可 |
| ALL | 所有人都要通过 |

### 6.10 T_COST_DICTIONARY_ITEM.EXTRA_CONFIG

**用途**：字典项扩展配置（颜色、图标等）

```json
{
  "color": "#67C23A",
  "bgColor": "#f0f9eb",
  "icon": "i-carbon-checkmark",
  "cssClass": "status-approved"
}
```

### 6.11 JSON 配置汇总表

| 表名 | 字段 | 用途 |
|------|------|------|
| T_COST_COLUMN_METADATA | RULES_CONFIG | 行级计算、格式化、校验、条件控制 |
| T_COST_LOOKUP_CONFIG | DISPLAY_COLUMNS | 弹窗显示列 |
| T_COST_LOOKUP_CONFIG | SEARCH_COLUMNS | 弹窗搜索字段 |
| T_COST_PAGE_COMPONENT | COMPONENT_CONFIG | 组件配置（按类型不同结构不同） |
| T_COST_ROLE_PAGE | BUTTON_POLICY | 按钮权限列表 |
| T_COST_ROLE_PAGE | COLUMN_POLICY | 列权限控制 |
| T_COST_ROLE_PAGE_DATA_RULE | RULE_CONFIG | 数据权限规则 |
| T_COST_USER_GRID_CONFIG | CONFIG_DATA | 用户表格偏好 |
| T_COST_PROCESS_DEFINITION | PROCESS_CONFIG | 流程定义（节点+连线） |
| T_COST_DICTIONARY_ITEM | EXTRA_CONFIG | 字典项扩展（颜色/图标） |

---

## 七、审计日志架构

### 7.1 设计目标

记录用户对业务数据的增删改操作，生成可读的自然语言描述，支持配置化控制哪些表需要审计。

### 7.2 审计开关配置

在 `T_COST_TABLE_METADATA` 表中已包含 `AUDIT_ENABLED` 字段（见 5.1 元数据表），设置为 1 即开启该表的审计日志。

### 7.3 审计日志表

```sql
CREATE TABLE T_COST_AUDIT_LOG (
    ID              NUMBER(19) PRIMARY KEY,
    TABLE_CODE      VARCHAR2(50) NOT NULL,       -- 操作的表编码
    TABLE_NAME      VARCHAR2(100),               -- 表中文名（冗余，方便查询）
    RECORD_ID       NUMBER(19) NOT NULL,         -- 操作的记录ID
    ACTION          VARCHAR2(20) NOT NULL,       -- 操作类型：CREATE/UPDATE/DELETE
    FIELD_CHANGES   CLOB,                        -- 字段变更明细 JSON
    DESCRIPTION     VARCHAR2(1000),              -- 自然语言描述
    USER_ID         NUMBER(19),
    USER_NAME       VARCHAR2(50),                -- 冗余，方便查询
    ACTION_TIME     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    IP_ADDRESS      VARCHAR2(50),
    USER_AGENT      VARCHAR2(500)
);

CREATE INDEX IDX_AUDIT_TABLE_CODE ON T_COST_AUDIT_LOG(TABLE_CODE);
CREATE INDEX IDX_AUDIT_RECORD_ID ON T_COST_AUDIT_LOG(TABLE_CODE, RECORD_ID);
CREATE INDEX IDX_AUDIT_USER_ID ON T_COST_AUDIT_LOG(USER_ID);
CREATE INDEX IDX_AUDIT_TIME ON T_COST_AUDIT_LOG(ACTION_TIME);

-- 序列
CREATE SEQUENCE SEQ_COST_AUDIT_LOG START WITH 1 INCREMENT BY 1;
```

### 7.4 字段变更 JSON 结构 (FIELD_CHANGES)

```json
{
  "changes": [
    {
      "field": "status",
      "label": "状态",
      "oldValue": "DRAFT",
      "newValue": "SUBMITTED",
      "oldLabel": "草稿",
      "newLabel": "已提交"
    },
    {
      "field": "amount",
      "label": "金额",
      "oldValue": 1000,
      "newValue": 2000,
      "oldLabel": "1000",
      "newLabel": "2000"
    }
  ]
}
```

| 字段 | 说明 |
|------|------|
| field | 字段名（小驼峰） |
| label | 字段中文名（来自 COLUMN_METADATA.HEADER_TEXT） |
| oldValue | 原始值 |
| newValue | 新值 |
| oldLabel | 原始值的显示文本（下拉框翻译后的值） |
| newLabel | 新值的显示文本 |

### 7.5 自然语言描述生成规则

| 操作 | 描述模板 |
|------|----------|
| CREATE | {用户名} 于 {时间} 新增了 {表名} 记录 |
| UPDATE | {用户名} 于 {时间} 修改了 {表名} ID={记录ID}：{字段名} 从 '{旧值}' 改为 '{新值}' |
| DELETE | {用户名} 于 {时间} 删除了 {表名} ID={记录ID} |

示例输出：
```
张三 于 2025-01-01 10:30:00 修改了 成本主表 ID=1：状态 从 '草稿' 改为 '已提交'；金额 从 '1000' 改为 '2000'
```

### 7.6 后端实现

#### 7.6.1 AuditLogService

```java
@Service
@RequiredArgsConstructor
public class AuditLogService {

    private final AuditLogMapper auditLogMapper;
    private final ColumnMetadataService columnMetadataService;
    private final DictionaryService dictionaryService;

    /**
     * 记录审计日志
     */
    @Async  // 异步执行，不影响主流程
    public void log(String tableCode, String tableName, Long recordId, 
                    String action, Map<String, Object> oldData, Map<String, Object> newData) {
        
        AuditLog log = new AuditLog();
        log.setTableCode(tableCode);
        log.setTableName(tableName);
        log.setRecordId(recordId);
        log.setAction(action);
        log.setUserId(SecurityUtils.getCurrentUserId());
        log.setUserName(SecurityUtils.getCurrentUserName());
        log.setActionTime(LocalDateTime.now());
        log.setIpAddress(WebUtils.getClientIp());
        
        // 生成字段变更明细
        if ("UPDATE".equals(action) && oldData != null && newData != null) {
            List<FieldChange> changes = buildFieldChanges(tableCode, oldData, newData);
            log.setFieldChanges(JSON.toJSONString(changes));
            log.setDescription(buildDescription(tableName, action, recordId, changes));
        } else {
            log.setDescription(buildDescription(tableName, action, recordId, null));
        }
        
        auditLogMapper.insert(log);
    }

    /**
     * 对比新旧数据，生成变更明细
     */
    private List<FieldChange> buildFieldChanges(String tableCode, 
                                                 Map<String, Object> oldData, 
                                                 Map<String, Object> newData) {
        List<FieldChange> changes = new ArrayList<>();
        
        // 获取列元数据（用于字段中文名和下拉翻译）
        Map<String, ColumnMetadata> columnMap = columnMetadataService
            .getByTableCode(tableCode)
            .stream()
            .collect(Collectors.toMap(ColumnMetadata::getFieldName, c -> c));
        
        for (Map.Entry<String, Object> entry : newData.entrySet()) {
            String field = entry.getKey();
            Object newValue = entry.getValue();
            Object oldValue = oldData.get(field);
            
            // 跳过系统字段
            if (isSystemField(field)) continue;
            
            // 值没变化则跳过
            if (Objects.equals(oldValue, newValue)) continue;
            
            ColumnMetadata col = columnMap.get(field);
            if (col == null) continue;
            
            FieldChange change = new FieldChange();
            change.setField(field);
            change.setLabel(col.getHeaderText());
            change.setOldValue(oldValue);
            change.setNewValue(newValue);
            
            // 下拉字段翻译值
            if ("select".equals(col.getDataType()) && col.getDictType() != null) {
                change.setOldLabel(dictionaryService.getLabel(col.getDictType(), oldValue));
                change.setNewLabel(dictionaryService.getLabel(col.getDictType(), newValue));
            } else {
                change.setOldLabel(String.valueOf(oldValue));
                change.setNewLabel(String.valueOf(newValue));
            }
            
            changes.add(change);
        }
        
        return changes;
    }

    /**
     * 生成自然语言描述
     */
    private String buildDescription(String tableName, String action, 
                                    Long recordId, List<FieldChange> changes) {
        String userName = SecurityUtils.getCurrentUserName();
        String time = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
        
        StringBuilder desc = new StringBuilder();
        desc.append(userName).append(" 于 ").append(time).append(" ");
        
        switch (action) {
            case "CREATE" -> desc.append("新增了 ").append(tableName).append(" 记录");
            case "DELETE" -> desc.append("删除了 ").append(tableName).append(" ID=").append(recordId);
            case "UPDATE" -> {
                desc.append("修改了 ").append(tableName).append(" ID=").append(recordId);
                if (changes != null && !changes.isEmpty()) {
                    desc.append("：");
                    for (int i = 0; i < changes.size(); i++) {
                        FieldChange c = changes.get(i);
                        if (i > 0) desc.append("；");
                        desc.append(c.getLabel())
                            .append(" 从 '").append(c.getOldLabel())
                            .append("' 改为 '").append(c.getNewLabel()).append("'");
                    }
                }
            }
        }
        
        return desc.toString();
    }

    private boolean isSystemField(String field) {
        return Set.of("id", "createBy", "createTime", "updateBy", "updateTime", "enabled")
            .contains(field);
    }
}
```

#### 7.6.2 DynamicDataService 集成

```java
@Service
@RequiredArgsConstructor
public class DynamicDataService {

    private final AuditLogService auditLogService;
    // ... 其他依赖

    @Transactional
    public Map<String, Object> create(String tableCode, Map<String, Object> data) {
        TableMetadata meta = validateAndGetMeta(tableCode);
        
        // 执行新增
        Long id = doInsert(meta, data);
        
        // 审计日志（配置开启才记录）
        if (Boolean.TRUE.equals(meta.getAuditEnabled())) {
            auditLogService.log(tableCode, meta.getTableName(), id, "CREATE", null, data);
        }
        
        return getById(tableCode, id);
    }

    @Transactional
    public Map<String, Object> update(String tableCode, Long id, Map<String, Object> newData) {
        TableMetadata meta = validateAndGetMeta(tableCode);
        
        // 审计日志需要先查旧数据
        Map<String, Object> oldData = null;
        if (Boolean.TRUE.equals(meta.getAuditEnabled())) {
            oldData = getById(tableCode, id);
        }
        
        // 执行更新
        doUpdate(meta, id, newData);
        
        // 审计日志
        if (Boolean.TRUE.equals(meta.getAuditEnabled())) {
            auditLogService.log(tableCode, meta.getTableName(), id, "UPDATE", oldData, newData);
        }
        
        return getById(tableCode, id);
    }

    @Transactional
    public void delete(String tableCode, Long id) {
        TableMetadata meta = validateAndGetMeta(tableCode);
        
        // 审计日志
        if (Boolean.TRUE.equals(meta.getAuditEnabled())) {
            auditLogService.log(tableCode, meta.getTableName(), id, "DELETE", null, null);
        }
        
        // 执行软删除
        doSoftDelete(meta, id);
    }
}
```

### 7.7 使用方式

1. 在 `T_COST_TABLE_METADATA` 中设置 `AUDIT_ENABLED = 1` 开启审计
2. 所有通过 `DynamicDataService` 的写操作自动记录
3. 查询审计日志：`SELECT * FROM T_COST_AUDIT_LOG WHERE TABLE_CODE = 'CostMaster' ORDER BY ACTION_TIME DESC`

### 7.8 注意事项

- 审计日志使用 `@Async` 异步写入，不影响主流程性能
- 下拉字段自动翻译为中文显示值
- 系统字段（createBy、updateTime 等）不记录变更
- 建议定期归档历史审计日志，避免表过大

---

## 八、架构总结

1. **元数据驱动**：所有业务表通过 `T_COST_TABLE_METADATA` + `T_COST_COLUMN_METADATA` 配置，无需编写 Entity/Mapper
2. **组件化页面**：页面由 `T_COST_PAGE_COMPONENT` 定义的组件树动态渲染
3. **四层权限**：页面 → 按钮 → 列 → 数据行，逐层细化控制
4. **JSON 配置**：复杂配置（按钮权限、列权限、组件配置、规则配置）统一使用 JSON 存储，减少表数量
5. **零代码扩展**：新增业务表只需配置元数据，无需编译部署

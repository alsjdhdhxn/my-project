---
trigger: always_on
---

# 成本管理系统开发规则

> 本规则用于约束项目开发，确保架构一致性，所有代码生成和修改必须遵循以下规范。

## 核心参考文档

开发时必须参考以下文档，确保实现与架构设计一致：

- 架构设计：#[[file:成本管理系统架构总结.md]]
- 技术栈：#[[file:技术栈清单-MP动态查询方案.md]]

---

## 角色与沟通

- 你是项目全权负责人，负责功能设计、架构设计、代码质量，我是你的主管
- 遇到不确定的地方先查询代码，还是不懂必须征求我的意见，不要擅自决策
- 我说错的地方要直接指出，不要盲目认同
- 不啰嗦讲重点，不要动不动写一大堆 md 文档
- 发现可以改进的地方主动提出并实施

---

## 通用开发原则

- **职责清晰**：每个文件、每个函数职责单一，不相关的代码不要混在一起
- **合理拆分**：大文件、大函数要及时拆分，使用合适的设计模式
- **类型统一**：前后端类型、字段、命名保持一致，避免 dataList/listData/items 这种不一致
- **影响评估**：任何改动都要评估对现有功能的影响，避免误删已有功能
- **生产优先**：不随便引入测试功能或依赖，不给生产环境增加负担
- **直面问题**：遇到问题要直面并解决，备选方案必须由我决策
- **主动重构**：发现字段冗余、命名不一致、代码重复时，主动优化
- **保持整洁**：修改功能时删除无用代码，重复代码立即抽象为公共方法

---

## 接口规范

统一响应格式：

```json
{
  "code": 200,
  "msg": "success",
  "data": {}
}
```

状态码约定：

| code | 说明 | 前端处理 |
|------|------|----------|
| 200 | 成功 | 正常处理 |
| 400 | 参数错误 | 提示错误信息 |
| 401 | Token 失效 | 刷新 Token |
| 403 | 无权限 | 登出跳转登录页 |
| 500 | 服务器错误 | 提示错误信息 |

分页数据格式：

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}
```

- 字段命名：统一使用 camelCase（驼峰），前后端保持一致
- 时间格式：统一使用 `yyyy-MM-dd HH:mm:ss` 格式，如 `2025-12-16 10:30:00`

---

## 开发环境

- 前端启动：`pnpm dev`（端口 9527）
- 后端启动：`mvn spring-boot:run` 或 IDEA 运行（端口 8080）
- 服务启动：我习惯自己启动服务，你不要擅自启动

---

## 一、架构原则（成本管理系统专属）

### 1.1 元数据驱动（核心原则）

- 所有 CRUD 页面必须通过元数据配置生成，禁止为单个业务表编写独立的 Controller/Service/Mapper
- 新增业务表只需配置 `T_COST_TABLE_METADATA` 和 `T_COST_COLUMN_METADATA`，前端自动渲染
- 动态查询使用 `DynamicMapper` + `QueryWrapper`，禁止为每个表创建独立 Mapper

### 1.2 数据访问分层

| 表类型 | 访问方式 | 说明 |
|--------|----------|------|
| 元数据表 | MyBatis-Plus + 实体类 | T_COST_TABLE_METADATA、T_COST_COLUMN_METADATA 等 |
| 基础数据/权限表 | MyBatis-Plus + 实体类 | T_COST_USER、T_COST_ROLE、T_COST_DEPARTMENT 等 |
| 业务数据表 | DynamicMapper | T_COST_DEMO 等，通过元数据驱动 |

- 元数据表和基础数据/权限表可以使用实体类，因为是系统基础设施
- 业务数据表禁止创建实体类，必须走 DynamicMapper 动态查询

### 1.2 组件树驱动页面

- 页面结构由 `T_COST_PAGE_COMPONENT` 组件树定义，前端统一使用 V2 渲染器
- 所有页面统一走 meta-v2 的通用渲染器
- V2 页面不再为单个业务编写独立 CRUD 组件

```vue
<!-- 全部页面统一使用 meta-v2 -->
<MasterDetailPageV2 v-if="pageCode" :pageCode="pageCode" />
```

### 1.3 规则配置模型（T_COST_PAGE_RULE）

| RULE_TYPE | 说明 | 场景 |
|-----------|------|------|
| CALC | 行级计算 | 金额 = 数量 × 单价 |
| AGGREGATE | 聚合计算 | 主表.总金额 = SUM(从表.金额) |
| COLUMN_OVERRIDE | 列覆盖 | 页面级列宽、可编辑、可见性 |
| VALIDATION | 验证规则 | 必填、范围校验 |
| LOOKUP | 弹窗选择器 | 字段关联 Lookup 配置 |
| BROADCAST | 广播字段 | 明细表字段变化通知主表 |
| SUMMARY_CONFIG | 汇总配置 | 嵌套表格底部汇总行 |
| ROLE_BINDING | 角色绑定 | 组件角色分配 |
| RELATION | 关联配置 | 主从表关系 |
| GRID_OPTIONS | 表格选项 | sideBar、分组、单元格选择等 |

补充（V2 兼容策略）：
- 规则优先级：T_COST_PAGE_RULE > COMPONENT_CONFIG（broadcast/aggregates/masterCalcRules/nestedConfig） > COLUMN_METADATA.rulesConfig（样式/计算/lookup/variant）
- 页面规则缺失时允许回退读取 COMPONENT_CONFIG / rulesConfig，避免旧配置失效

---

## 二、后端开发规范

### 2.1 技术栈约束

| 组件 | 必须使用 | 禁止使用 |
|------|----------|----------|
| 框架 | Spring Boot 3.2.x | Spring Boot 2.x |
| 持久层 | MyBatis-Plus 3.5.5+ | 原生 MyBatis、JPA |
| 连接池 | Druid | HikariCP |
| 安全 | Spring Security + JWT | Shiro |
| 工具库 | Hutool | Apache Commons |

### 2.2 动态数据接口规范

```text
GET    /api/data/{tableCode}           - 查询列表
POST   /api/data/{tableCode}/search    - 高级查询
GET    /api/data/{tableCode}/{id}      - 查询单条
POST   /api/data/{tableCode}           - 新增
PUT    /api/data/{tableCode}/{id}      - 更新
DELETE /api/data/{tableCode}/{id}      - 删除（软删除）
```

- 所有业务数据接口必须走 `DynamicDataController`
- 禁止为单个业务表创建独立的 Controller

### 2.3 元数据接口规范

```text
GET    /api/metadata/table/{tableCode}     - 获取表元数据 + 列元数据
GET    /api/metadata/page/{pageCode}       - 获取页面组件树
GET    /api/metadata/lookup/{lookupCode}   - 获取弹窗选择器配置
GET    /api/metadata/dict/{dictType}       - 获取字典项
```

- 元数据接口由 `MetadataController` 统一提供
- 前端缓存元数据，避免重复请求

### 2.4 SQL 安全三道防线

1. **元数据白名单**：表名、列名必须在元数据中定义
2. **QueryWrapper 预编译**：查询条件值自动预编译
3. **Druid WallFilter**：禁止 DROP、TRUNCATE、多语句执行

### 2.5 Mapper 规范

- 使用 `@Select`/`@Insert`/`@Update` 注解，禁止使用 XML 配置
- 动态表名使用 `${tableName}`，必须经过白名单校验
- 动态值使用 `#{value}`，自动预编译

---

## 三、前端开发规范

### 3.1 技术栈约束

| 组件 | 必须使用 | 禁止使用 |
|------|----------|----------|
| 基础框架 | Soybean Admin | 其他模板 |
| UI 组件库 | Naive UI | Element Plus、Ant Design |
| 表格 | AG Grid | VxeTable、原生 table |
| 表单生成 | form-create | Formily |
| 状态管理 | Pinia | Vuex |

### 3.2 V2 组件架构（src/composables/meta-v2）

| 文件 | 职责 |
|------|------|
| useMetaConfig.ts | 加载页面元数据并解析配置 |
| usePageRules.ts | 解析各类规则（CALC/AGGREGATE/LOOKUP 等） |
| registry.ts | 规则解析器 / 组件扩展 / 保存钩子注册表 |
| useMasterDetailData.ts | 主从数据加载与缓存 |
| useSave.ts | 保存逻辑 |
| useCalcBroadcast.ts | 计算引擎 + 广播 |

#### 3.2.1 Runtime 架构（BaseRuntime + 组合式派生）
- **BaseRuntime**：统一负责元数据加载、权限合并、保存、列配置、错误收集与日志上下文
- **SingleGridRuntime**：通过组合 BaseRuntime + features 开关，仅启用需要的能力
- **MasterDetailRuntime**：通过组合 BaseRuntime + features 开关，启用主从/Tab/广播/聚合等能力
- **共通逻辑只放 BaseRuntime**，派生仅决定“启用哪些特性”，避免重复维护
 
阶段依赖必须显式化：
- loadComponents → parseConfig → loadMeta → compileRules → buildStates → applyExtensions
- loadComponents 失败：页面整体 status=error（无组件树无法渲染）
- 其余阶段允许降级，组件级 status=error 即可

#### 3.2.2 组件状态契约（ComponentState）
- 渲染器只能消费 `componentStateByKey[componentKey]`
- `ComponentState` 必须是**纯值**（不允许 Ref）
- 必须包含 `status: ready/loading/error` 与 `error`（若有）
- Grid 事件建议**扁平化**为 `onGridReady/onCellValueChanged/...`，避免多一层 events 包装

#### 3.2.3 错误隔离与日志规范
- 任一组件出错只影响该组件，其他组件继续渲染
- 错误必须带定位信息：`pageCode + componentKey + stage`
- 统一日志格式：`[MetaV2][pageCode][componentKey][stage] message`

#### 3.2.4 unwrap 防御策略
- 短期：渲染器内部可统一 `unref` 防御
- 中期：在 Runtime 层统一规范输出为纯值
- 长期：类型层面禁止 Ref 进入 ComponentState

#### 3.2.5 Runtime Features 约定
- features 使用对象结构，便于扩展与按需启用：
  - `detailTabs` / `broadcast` / `aggregates` / `lookup`
  - `export` / `contextMenu` 等后续能力

#### 3.2.6 buildStates / applyExtensions 分工
- buildStates 负责**数据**（列/行/配置/状态）
- applyExtensions 负责**事件/交互**（回调/上下文菜单/导出等）
- 两者都可写入 `componentStateByKey`，但职责严格区分

#### 3.2.7 迁移回滚开关
- 每个 pageCode 支持 Runtime 切换开关，便于灰度与回滚

### 3.3 V2 渲染器组件（src/components/meta-v2/renderers）

| 组件 | COMPONENT_TYPE | 职责 |
|------|----------------|------|
| MasterDetailLayoutRenderer | MASTER_DETAIL | 主从布局渲染 |
| MetaGrid | GRID | AG Grid 表格 |
| MetaForm | FORM | 表单 |
| MetaButton | BUTTON | 按钮 |
| DetailTabsPanel | - | 从表 Tabs 面板 |

### 3.4 页面渲染流程（V2）

```
1. 路由 → 根据 pageCode 渲染 MasterDetailPageV2
2. useMetaConfig 加载组件树 + 规则
3. 规则按 componentKey 分组 → rulesByComponent
4. 各组件读取自己的规则并渲染
5. calc-engine 处理行级计算 + 聚合计算
```

---

## 四、元数据配置规范

### 4.1 表元数据 (T_COST_TABLE_METADATA)

```sql
-- TABLE_CODE 使用大驼峰命名
-- QUERY_VIEW 用于查询（可关联多表或视图）
-- TARGET_TABLE 用于保存（单表）
-- PARENT_TABLE_CODE + PARENT_FK_COLUMN 用于主从关系
INSERT INTO T_COST_TABLE_METADATA (TABLE_CODE, TABLE_NAME, QUERY_VIEW, TARGET_TABLE, SEQUENCE_NAME, PK_COLUMN)
VALUES ('CostPinggu', '成本评估', 'T_COST_PINGGU', 'T_COST_PINGGU', 'SEQ_COST_PINGGU', 'DOCID');
```

### 4.2 列元数据 (T_COST_COLUMN_METADATA)

```sql
-- FIELD_NAME 使用小驼峰命名（前端用）
-- COLUMN_NAME 使用大写下划线（数据库用）
-- DATA_TYPE: text/number/date/select/lookup
-- 注意：V2 规则优先走 T_COST_PAGE_RULE，但仍兼容 rulesConfig（样式/计算/lookup/variant 等）作为回退
INSERT INTO T_COST_COLUMN_METADATA (TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER)
VALUES (1, 'goodsname', 'GOODSNAME', '产品名称', 'text', 1);
```

### 4.3 页面规则 (T_COST_PAGE_RULE) — V2 新增

```sql
-- RULE_TYPE: CALC / AGGREGATE / COLUMN_OVERRIDE / VALIDATION
-- COMPONENT_KEY 关联页面组件
-- RULES 存储 JSON 数组
INSERT INTO T_COST_PAGE_RULE (PAGE_CODE, COMPONENT_KEY, RULE_TYPE, RULES)
VALUES ('cost-pinggu-v2', 'masterGrid', 'CALC', 
  '[{"field":"salemoney","expression":"outPriceRmb / pPerpack * apexPl","triggerFields":["outPriceRmb","pPerpack","apexPl"]}]');
```

### 4.4 页面组件 (T_COST_PAGE_COMPONENT)

```sql
-- COMPONENT_TYPE: GRID/FORM/BUTTON/LAYOUT/TABS/LOGIC_*
-- REF_TABLE_CODE 关联表元数据
INSERT INTO T_COST_PAGE_COMPONENT (PAGE_CODE, COMPONENT_KEY, COMPONENT_TYPE, REF_TABLE_CODE)
VALUES ('cost-pinggu-v2', 'masterGrid', 'GRID', 'CostPinggu');
```

---

## 五、权限配置规范

### 5.1 四层权限模型

| 层级 | 配置表 | 控制粒度 |
|------|--------|----------|
| 页面权限 | T_COST_ROLE_PAGE.PAGE_CODE | 能否访问页面 |
| 按钮权限 | T_COST_ROLE_PAGE.BUTTON_POLICY | 能否执行操作 |
| 列权限 | T_COST_ROLE_PAGE.COLUMN_POLICY | 列可见/可编辑 |
| 数据权限 | T_COST_ROLE_PAGE_DATA_RULE | 行级数据过滤 |

### 5.2 权限合并规则

```text
基础层 (COLUMN_METADATA) → 限制层 (ROLE_PAGE) → 偏好层 (USER_GRID_CONFIG)
```

- 多角色权限合并取并集（任一角色允许即可；全部禁止才禁止）
- 角色权限在基础元数据范围内生效（基础隐藏/不可编辑不能被放开）
- 用户偏好只能收紧可见/可编辑；列顺序/列宽/冻结可按个人偏好调整

---

## 六、命名规范

### 6.1 数据库命名

| 对象 | 规范 | 示例 |
|------|------|------|
| 表名 | T_COST_大写下划线 | T_COST_MASTER |
| 视图 | V_COST_大写下划线 | V_COST_MASTER |
| 序列 | SEQ_大写下划线 | SEQ_COST_MASTER |
| 索引 | IDX_表名_列名 | IDX_COST_MASTER_CODE |

### 6.2 代码命名

| 对象 | 规范 | 示例 |
|------|------|------|
| tableCode | 大驼峰 | CostMaster |
| fieldName | 小驼峰 | costDate |
| 组件 Key | 小驼峰 | masterForm |
| 页面 Code | 小写中划线 | cost-master |

---

## 七、禁止事项清单

1. ❌ 禁止为单个业务表创建独立的 Controller/Service/Mapper
2. ❌ 禁止为单个业务表创建独立的 Vue 页面组件
3. ❌ 禁止在代码中硬编码表名、列名
4. ❌ 禁止使用 XML 配置 MyBatis SQL
5. ❌ 禁止绕过元数据直接操作数据库
6. ❌ 禁止在前端硬编码计算逻辑，必须配置在 T_COST_PAGE_RULE 表中
7. ❌ 禁止使用 Element Plus、Ant Design 等非 Naive UI 组件
8. ❌ 禁止使用 Vuex 替代 Pinia
9. ❌ 禁止擅自创建实体类（Entity）或 Service，必须先征求主管意见
10. ❌ 禁止使用 `enableRangeSelection`，改用 `cellSelection: true`
11. ❌ 禁止使用字符串形式的 `rowSelection: 'single'`，改用对象形式
12. ❌ 禁止参考 AG Grid v32 及以下版本的文档或示例代码
13. ❌ 禁止在组件中硬编码列定义，必须从元数据获取
14. ❌ 禁止绕过 calc-engine 直接写计算逻辑

---

## 八、技术查询优先级

遇到不熟悉的技术或 API 时，按以下顺序查询：

1. **优先使用 MCP 查询官方文档**：通过 MCP 工具获取官方最新文档
2. **查询成熟项目案例**：如果官方文档查不到，搜索 GitHub 上成熟项目的实现方式
3. **最后才进行推测**：只有在前两步都无法获取信息时，才基于经验进行合理推测，并明确告知用户这是推测

禁止在未查证的情况下直接编造 API 用法或配置方式。

---

## 九、AG Grid 开发规范

AG Grid 更新频繁，API 变化较大，开发时必须遵循以下规则：

### 9.1 版本与文档

- **当前项目版本**：v35.0.0
- **官方文档地址**：https://www.ag-grid.com/vue-data-grid/
- **每次写 AG Grid 代码前，必须先查询官方文档**，确认 v35 版本的正确用法
- 禁止参考旧版本文档（如 v27、v28、v31、v32 等）

### 9.2 v35 重要 API 变更

| 废弃 API | 新 API | 说明 |
|----------|--------|------|
| `enableRangeSelection` | `cellSelection: true` | v32.2 起废弃 |
| `rowSelection: 'single'/'multiple'` | `rowSelection: { mode: 'singleRow'/'multiRow' }` | v35 新写法 |
| `suppressRowClickSelection` | `rowSelection: { enableClickSelection: false }` | v35 新写法 |

### 9.3 企业版功能配置（v35）

```typescript
// Master-Detail 配置
{
  masterDetail: true,
  detailCellRendererParams: {
    detailGridOptions: { columnDefs: [...] },
    getDetailRowData: (params) => { params.successCallback(data); }
  }
}

// 单元格选择（替代 enableRangeSelection）
{ cellSelection: true }

// 行选择新写法
{ rowSelection: { mode: 'singleRow', enableClickSelection: true } }
```

### 9.4 查询文档的关键页面

- Master-Detail：https://www.ag-grid.com/vue-data-grid/master-detail/
- Row Selection：https://www.ag-grid.com/vue-data-grid/row-selection/
- Cell Selection：https://www.ag-grid.com/vue-data-grid/cell-selection/
- Excel Export：https://www.ag-grid.com/vue-data-grid/excel-export/
- Row Grouping：https://www.ag-grid.com/vue-data-grid/grouping/

# 执行器配置迁移手册

## 1. 背景与目标
- 验证器只做验证：读取 `VALIDATION_RULES`，执行 SQL，返回结果
- 执行器只做执行：读取 `ACTION_RULES`，按类型调用 SQL/Java/Proc
- 旧的 `validationRules.action` 已废弃，需要迁移到 `ACTION_RULES`

## 2. 变更点总览
- 数据库：`T_COST_TABLE_METADATA` 新增 `ACTION_RULES`（CLOB）
- 配置：`VALIDATION_RULES` 仅保留验证规则，`ACTION_RULES` 保存执行器
- 接口：新增 `/api/data/{tableCode}/validate` 与 `/api/data/{tableCode}/execute`
- 保存流程：自动先验证 `group=save`，再执行 `group=after_save`

## 3. 迁移步骤

### 3.1 数据库迁移
执行 `cost-server/src/main/resources/db/migration/V3__add_action_rules.sql`。

如果需要手工执行：
```sql
ALTER TABLE T_COST_TABLE_METADATA ADD ACTION_RULES CLOB;
```

### 3.2 找出需要迁移的表
```sql
SELECT TABLE_CODE, VALIDATION_RULES
FROM T_COST_TABLE_METADATA
WHERE VALIDATION_RULES LIKE '%"action"%';
```

### 3.3 字段映射（旧 -> 新）
| 旧字段 | 新字段 | 说明 |
| --- | --- | --- |
| `validationRules[i].action.enabled` | `actionRules[i].enabled` | 不配置时默认启用 |
| `validationRules[i].action.sql` | `actionRules[i].sql` | 旧 action 仅支持 SQL |
| `validationRules[i].action.description` | `actionRules[i].description` | 描述说明 |
| `validationRules[i].name` | `actionRules[i].code` | 建议使用 `code` 作为唯一标识 |
| `validationRules[i].order` | `actionRules[i].order` | 可复用执行顺序 |
| *无* | `actionRules[i].type` | 旧 action 对应 `sql` |
| *无* | `actionRules[i].group` | 常用 `after_save` 或 `manual` |

### 3.4 迁移规则
1. 从 `VALIDATION_RULES` 中拆出 `action` 对象
2. 生成新的 `ACTION_RULES`（JSON 数组）
3. 设置 `type` 为 `sql`
4. 设置 `group`
   - 保存后自动执行：`after_save`
   - 手工按钮执行：`manual`
   - 也可自定义，如 `approve`、`cancel`
5. 更新 `ACTION_RULES`
6. 从 `VALIDATION_RULES` 中删除 `action` 字段

### 3.5 示例：CostUser
保存后加密密码（自动执行）：
```sql
UPDATE T_COST_TABLE_METADATA
SET ACTION_RULES = '[
  {
    "code": "encryptPassword",
    "group": "after_save",
    "type": "java",
    "method": "userService.encryptPassword",
    "description": "保存后加密密码"
  }
]'
WHERE TABLE_CODE = 'CostUser';
```

右键菜单“重置密码”（手工执行）：
```sql
UPDATE T_COST_TABLE_METADATA
SET ACTION_RULES = '[
  {
    "code": "resetPassword",
    "group": "manual",
    "type": "java",
    "method": "userService.resetPassword",
    "description": "重置密码"
  }
]'
WHERE TABLE_CODE = 'CostUser';
```

### 3.6 迁移后调用方式
只验证：
```json
POST /api/data/CostUser/validate
{ "group": "save", "data": { "id": 1, "username": "tom" } }
```

手工执行（指定 code）：
```json
POST /api/data/CostUser/execute
{ "actionCodes": ["resetPassword"], "data": { "id": 1 } }
```

执行前先验证：
```json
POST /api/data/CostUser/execute
{ "group": "manual", "validate": true, "validateGroup": "save", "data": { "id": 1 } }
```

## 4. 验证清单
- [ ] `ACTION_RULES` 字段已存在
- [ ] `VALIDATION_RULES` 中已移除 `action`
- [ ] 每条 `action` 已迁移到 `ACTION_RULES`
- [ ] 保存流程能执行 `after_save`
- [ ] 手工按钮能通过 `/execute` 正常调用
- [ ] `/validate` 与 `/execute` 返回结果正常

## 5. 注意事项
- `ACTION_RULES` 中 `group` 为空会匹配所有分组，建议显式配置
- 当 `actionCodes` 不为空时，执行器按 `code` 过滤，忽略 `group`
- 权限控制不在执行器内处理，请在按钮或上游接口中控制

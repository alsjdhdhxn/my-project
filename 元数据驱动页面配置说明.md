# 元数据驱动页面配置说明（Meta-V2）

本文档说明“完全配置化”的规则：
- 布局/结构放 `T_COST_PAGE_COMPONENT.COMPONENT_CONFIG`
- 行为/规则放 `T_COST_PAGE_RULE`
- 单表和主从表共用同一套运行时

---

## 1. 配置来源与优先级

### 1.1 数据来源
- 页面结构：`T_COST_PAGE_COMPONENT`
- 页面规则：`T_COST_PAGE_RULE`
- 表/列元数据：`T_COST_TABLE_METADATA` / `T_COST_COLUMN_METADATA`

### 1.2 规则优先级（高 → 低）
1) `T_COST_PAGE_RULE`（页面规则）
2) `T_COST_PAGE_COMPONENT.COMPONENT_CONFIG`（结构配置）
3) 列元数据（默认行为/验证/Lookup）

> 规则表中同一组件同一 `RULE_TYPE` 只保留一条，内容写成一个 JSON。

---

## 2. 组件配置（按组件）

### 2.1 LAYOUT（布局容器）
**用途**：容器/分区，承载子组件。

**COMPONENT_CONFIG**
```json
{
  "direction": "vertical",
  "gap": 8,
  "align": "stretch",
  "justify": "flex-start"
}
```

**示例：上下布局**
```json
{ "direction": "vertical", "gap": 12 }
```

---

### 2.2 GRID（单表/主表）
**用途**：单表页面 or 主表 Grid。

**必填字段**
- `REF_TABLE_CODE`：绑定表元数据

**COMPONENT_CONFIG（可选）**
```json
{
  "width": "100%",
  "height": "50%",
  "className": "my-grid"
}
```

**角色绑定（推荐）**
- 在 `T_COST_PAGE_RULE` 配置 `ROLE_BINDING`：
```json
{ "role": "MASTER_GRID" }
```

**示例 A：单表页面（只有一个 GRID）**
- 无需 `ROLE_BINDING`，系统自动识别为主表。

**示例 B：同页多 GRID**
- 必须给主表 GRID 加 `ROLE_BINDING=MASTER_GRID`。

---

### 2.3 TABS（主从明细配置）
**用途**：主从页面的明细结构配置（不渲染 Tab UI，仅作为明细组织配置）。

**COMPONENT_CONFIG（结构）**
```json
{
  "mode": "multi",
  "tabs": [
    { "key": "material", "title": "原料/辅料", "tableCode": "CostMaterial" },
    { "key": "package", "title": "包材", "tableCode": "CostPackage" }
  ]
}
```

**模式说明**
- `mode: group`：同一张明细表，按字段值分组展示
- `mode: multi`：多表明细，tab 对应不同表

**示例 C：group 模式**
```json
{
  "mode": "group",
  "groupField": "dtlUseflag",
  "tabs": [
    { "key": "ylfl", "title": "原料/辅料", "values": ["原料", "辅料"] },
    { "key": "bc", "title": "包材", "values": ["包材", "印字包材"] }
  ]
}
```

**旧方式（兼容）**
- `broadcast/aggregates/masterCalcRules/nestedConfig` 可写在 `COMPONENT_CONFIG`，但优先从 `T_COST_PAGE_RULE` 读取。

---

### 2.4 FORM（表单）
**用途**：占位表单，可通过扩展注入自定义渲染器。

**默认行为**
- 未扩展时显示占位提示。

**扩展示例（注册自定义渲染器）**
```ts
registerComponentExtension({
  key: 'form-custom',
  match: c => c.componentType === 'FORM',
  apply: ({ state }) => {
    state.renderer = MyFormRenderer;
    state.placeholder = '自定义表单';
  }
});
```

---

### 2.5 BUTTON（按钮）
**用途**：触发运行时动作或自定义事件。

**COMPONENT_CONFIG**
```json
{
  "label": "保存",
  "type": "primary",
  "size": "medium",
  "action": "save"
}
```

**示例 D：调用运行时方法**
```json
{ "label": "新增", "type": "primary", "action": "addMasterRow" }
```

**示例 E：扩展自定义 click**
```ts
registerComponentExtension({
  key: 'button-custom',
  match: c => c.componentType === 'BUTTON',
  apply: ({ state }) => {
    state.onClick = ({ runtime }) => runtime.save();
    state.disabled = false;
  }
});
```

---

## 3. 页面规则（RULE_TYPE）

> 每个组件每种 `RULE_TYPE` 只保留一条，JSON 写入 `RULES` 字段。

### 3.1 COLUMN_OVERRIDE（列覆盖）
```json
[
  { "field": "goodsname", "width": 150, "editable": true, "searchable": true },
  { "field": "id", "visible": false, "editable": false }
]
```

### 3.2 CALC（计算规则）
**单公式**
```json
[
  { "field": "salemoney", "expression": "outPriceRmb / pPerpack * apexPl", "triggerFields": ["outPriceRmb", "pPerpack", "apexPl"] }
]
```

**多公式（按字段切换）**
```json
[
  {
    "field": "batchQty",
    "formulaField": "formulaType",
    "formulas": {
      "A": { "expression": "apexPl / pPerpack", "triggerFields": ["apexPl", "pPerpack"] },
      "E": { "expression": "ceil(apexPl / (pPerpack * sPerback))", "triggerFields": ["apexPl", "pPerpack", "sPerback"] }
    }
  }
]
```

### 3.3 VALIDATION（前端校验）
```json
[
  { "field": "perHl", "required": true, "min": 0.001, "message": "每片含量必填" },
  { "field": "price", "min": 0, "message": "单价不能为负数" }
]
```

### 3.4 LOOKUP（弹窗回填）
```json
[
  { "field": "apexGoodsname", "lookupCode": "material", "mapping": { "apexGoodsname": "materialName", "spec": "spec", "price": "price" } }
]
```

### 3.5 AGGREGATE（主表汇总）
```json
[
  { "sourceField": "costBatch", "targetField": "totalYl", "algorithm": "SUM", "filter": "dtlUseflag === '原料'" },
  { "targetField": "totalCost", "expression": "totalYl + totalFl + totalBc" }
]
```

### 3.6 BROADCAST（主 → 从广播字段）
**数组形式**
```json
["apexPl", "pPerpack", "sPerback", "xPerback"]
```

**对象形式（兼容）**
```json
{ "fields": ["apexPl", "pPerpack"] }
```

### 3.7 SUMMARY_CONFIG / NESTED_CONFIG（汇总行配置）
```json
{
  "enabled": true,
  "groupLabelField": "groupLabel",
  "groupLabelHeader": "分类",
  "summaryColumns": [
    { "field": "totalAmount", "headerName": "汇总金额", "width": 120 },
    { "field": "rowCount", "headerName": "行数", "width": 80 }
  ],
  "summaryAggregates": [
    { "sourceField": "costBatch", "targetField": "totalAmount", "algorithm": "SUM" },
    { "targetField": "rowCount", "algorithm": "COUNT" }
  ]
}
```

### 3.8 ROLE_BINDING（组件角色）
```json
{ "role": "MASTER_GRID" }
```

可用角色：
- `MASTER_GRID` / `MASTER`
- `DETAIL_TABS` / `DETAIL`

### 3.9 RELATION（主从关系）
```json
{ "masterKey": "masterGrid", "detailKey": "detailTabs" }
```

---

## 4. 单表页面示例

**组件结构**
- LAYOUT(root)
  - GRID(grid)

**T_COST_PAGE_COMPONENT**
```json
{
  "componentKey": "grid",
  "componentType": "GRID",
  "refTableCode": "CostUser",
  "componentConfig": "{\"height\":\"100%\"}"
}
```

**T_COST_PAGE_RULE（grid）**
```json
// COLUMN_OVERRIDE
[
  { "field": "id", "visible": false },
  { "field": "username", "width": 120, "editable": true }
]
```

---

## 5. 主从页面示例（cost-pinggu-v2）

**组件结构**
- LAYOUT(root)
  - GRID(masterGrid)
  - TABS(detailTabs)

**T_COST_PAGE_RULE（detailTabs）**
```json
// ROLE_BINDING
{ "role": "DETAIL_TABS" }
```

```json
// BROADCAST
["apexPl", "pPerpack", "sPerback", "xPerback"]
```

```json
// SUMMARY_CONFIG
{
  "enabled": true,
  "groupLabelHeader": "分类",
  "summaryAggregates": [
    { "sourceField": "costBatch", "targetField": "totalAmount", "algorithm": "SUM" }
  ]
}
```

---

## 6. 验证器与执行器

### 6.1 前端验证（VALIDATION）
- 位置：`T_COST_PAGE_RULE`（按组件）
- 执行时机：`save` 时逐行校验
- 支持字段：`required/min/max/pattern/notZero`

**示例**
```json
[
  { "field": "price", "required": true, "min": 0, "message": "单价必填" }
]
```

### 6.2 后端验证（VALIDATION_RULES）
- 位置：`T_COST_TABLE_METADATA.VALIDATION_RULES`
- 执行方式：按 `order` 顺序逐条执行，第一条失败即终止
- 分组：`group` 过滤

**示例**
```json
[
  {
    "order": 10,
    "code": "check_unique",
    "group": "save",
    "sql": "select count(1) from T_COST_USER where USERNAME = :username",
    "condition": "result == 0",
    "message": "用户名已存在"
  }
]
```

### 6.3 后端执行器（ACTION_RULES）
- 位置：`T_COST_TABLE_METADATA.ACTION_RULES`
- `type` 支持：`sql` / `java` / `proc`
- 分组：`group` 过滤，或通过 `actionCodes` 精确执行

**SQL 执行器示例**
```json
[
  {
    "order": 10,
    "code": "resetPwd",
    "type": "sql",
    "sql": "update T_COST_USER set PASSWORD = :password where ID = :id"
  }
]
```

**Java 执行器示例**
```json
[
  {
    "order": 10,
    "code": "syncUser",
    "type": "java",
    "handler": "userSyncHandler"
  }
]
```

**存储过程执行器示例**
```json
[
  {
    "order": 10,
    "code": "procDemo",
    "type": "proc",
    "procedure": "P_COST_DEMO",
    "params": [
      { "mode": "IN", "source": "data.id" },
      { "mode": "OUT", "target": "data.result" }
    ]
  }
]
```

**执行 API**
```
POST /api/data/{tableCode}/execute
{
  "group": "manual",
  "actionCodes": ["resetPwd"],
  "data": { "id": 1 },
  "validate": true,
  "validateGroup": "save"
}
```

---

## 7. 扩展方式

### 7.1 新增组件渲染器
1) 新建 `components/meta-v2/renderers/xxx.renderer.ts`
2) 注册：`registerComponentRenderer({ componentType: 'XXX', renderer })`
3) 自动加载：`initComponentRenderers()` 会扫描 `*.renderer.ts`

### 7.2 新增组件扩展（绑定运行时数据）
1) 新建 `composables/meta-v2/extensions/xxx.extension.ts`
2) 注册：`registerComponentExtension({ apply })`
3) 自动加载：`initComponentExtensions()` 会扫描 `*.extension.ts`

### 7.3 新增规则类型
1) 数据库新增 `RULE_TYPE`
2) 前端注册解析器：`registerRuleParser('NEW_RULE', parser)`
3) 在组件扩展中消费该规则

---

## 8. 配置小结
- LAYOUT 负责结构
- GRID/TABS 负责页面主体结构
- 行为规则全部落在 `T_COST_PAGE_RULE`
- 前后端验证/执行均可按“逐条”运行

如需新增组件或规则，只需要增加扩展文件并配置元数据即可，无需修改已有页面代码。

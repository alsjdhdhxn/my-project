# 三层嵌套 Master-Detail 开发计划

## 目标

扩展现有 `MasterDetailPage.vue`，支持 AG Grid 原生三层嵌套展示（主表 → 汇总行 → 明细 Grid），通过元数据配置切换展示模式，支持变体列。

---

## 阶段一：元数据配置解析 ✅

**改动文件**：`cost-web/src/logic/calc-engine/parser.ts`

**改动内容**：
- [x] 新增 `NestedConfig` 接口（enabled, summaryColumns, summaryAggregates, groupLabelField）
- [x] 新增 `SummaryAggConfig` 接口（sourceField, targetField, algorithm）
- [x] 新增 `SummaryColumnConfig` 接口（field, headerName, width）
- [x] `TabConfig` 增加 `variantKey` 字段
- [x] `ParsedPageConfig` 增加 `nestedConfig` 字段
- [x] `parsePageComponents()` 解析 nestedConfig

**目的**：通过元数据驱动三层嵌套的展示和计算

---

## 阶段二：Store 扩展 - 汇总行 computed ✅

**改动文件**：`cost-web/src/store/modules/master-detail/index.ts`

**改动内容**：
- [x] 新增 `summaryRows` computed，按 Tab 分组
- [x] 汇总行包含：_groupKey、_groupValue、groupLabel、_detailRows、_variantKey、聚合字段

**目的**：为三层嵌套的第二层提供数据源

---

## 阶段三：页面组件支持嵌套模式 ✅

**改动文件**：`cost-web/src/components/meta-v4/MasterDetailPage.vue`

**改动内容**：
- [x] 新增 `isNestedMode` computed 检测嵌套模式
- [x] 新增 `masterDetailParams` computed 配置主表 Master-Detail
- [x] 新增 `getSummaryDetailParams()` 配置汇总行展开到明细 Grid
- [x] 新增 `onMasterRowExpanded()` 处理主表展开事件
- [x] 模板增加三层嵌套模式分支

**目的**：同一组件支持分屏和嵌套两种模式

---

## 阶段四：变体列支持

**改动文件**：
- [ ] 后端：`T_COST_COLUMN_METADATA` 增加 `VARIANT_KEY` 字段（或在 RULES_CONFIG 中配置）
- [x] 前端：`useMetaColumns.ts` 增加 `filterColumnsByVariant()` 函数
- [x] `getSummaryDetailParams()` 改为函数形式，根据 `_variantKey` 动态返回列定义

**目的**：不同分组显示不同列（原辅料 vs 包材）

**说明**：变体列配置方式有两种选择：
1. 在 `T_COST_COLUMN_METADATA` 增加 `VARIANT_KEY` 字段
2. 在现有 `RULES_CONFIG` JSON 中增加 `variantKey` 属性

建议使用方案 2，无需改数据库结构，配置示例：
```json
{"variantKey": "原辅料", "calculate": {...}}
```

---

## 阶段五：编辑与计算 ✅

**改动内容**：
- [x] 明细 Grid 添加 `onCellValueChanged` 事件，调用 `store.updateField()`
- [x] 复用现有计算链：行级计算 → 聚合计算 → 主表更新
- [x] `summaryRows` 是 computed，自动响应 `detailRowsByTab` 变化

**目的**：保持计算逻辑一致

**说明**：
- 明细行编辑 → `updateField()` → 触发行级计算 → 触发聚合计算
- `summaryRows` computed 会自动重算聚合值
- 主表聚合由现有 `triggerAggCalc()` 处理

---

## 阶段六：保存与收尾 ✅

**改动内容**：
- [x] 保存逻辑复用 `buildSaveParams()`，数据结构不变
- [x] 删除测试组件 `MasterDetailNested.vue`
- [x] 清理 `dynamic/index.vue` 中的 `?nested=1` 测试代码

**目的**：功能完整可用

---

## 当前进度

**全部阶段完成！**

三层嵌套功能已整合到 `MasterDetailPage.vue`，通过元数据配置 `nestedConfig.enabled: true` 启用。

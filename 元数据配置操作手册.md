# 元数据配置操作手册

## 一、新增页面配置流程

新增一个页面需要配置 4 张表：

| 步骤 | 配置表 | 说明 |
|------|--------|------|
| 1 | T_COST_RESOURCE | 菜单入口 |
| 2 | T_COST_TABLE_METADATA | 表定义 |
| 3 | T_COST_COLUMN_METADATA | 列定义 |
| 4 | T_COST_PAGE_COMPONENT | 页面组件 |

---

## 二、页面类型配置示例

### 2.1 单表页面（如：人员管理）

**场景**：只有一个表格，无主从关系

```sql
-- 1. 菜单
INSERT INTO T_COST_RESOURCE (ID, RESOURCE_CODE, RESOURCE_NAME, RESOURCE_TYPE, PAGE_CODE, ICON, ROUTE, PARENT_ID, SORT_ORDER, CREATE_BY)
VALUES (SEQ_COST_RESOURCE.NEXTVAL, 'user', '人员管理', 'PAGE', 'user-manage', 'mdi:account-group', '/system/user', 父级ID, 1, 'system');

-- 2. 表元数据
INSERT INTO T_COST_TABLE_METADATA (ID, TABLE_CODE, TABLE_NAME, QUERY_VIEW, TARGET_TABLE, SEQUENCE_NAME, PK_COLUMN, CREATE_BY)
VALUES (SEQ_COST_TABLE_METADATA.NEXTVAL, 'CostUser', '用户', 'V_COST_USER', 'T_COST_USER', 'SEQ_COST_USER', 'ID', 'system');

-- 3. 列元数据（略）

-- 4. 页面组件（关键：只有 LAYOUT + GRID，无 TABS）
INSERT INTO T_COST_PAGE_COMPONENT (ID, PAGE_CODE, COMPONENT_KEY, COMPONENT_TYPE, PARENT_KEY, SORT_ORDER, COMPONENT_CONFIG, CREATE_BY)
VALUES (SEQ_COST_PAGE_COMPONENT.NEXTVAL, 'user-manage', 'root', 'LAYOUT', NULL, 0, '{"direction":"vertical","gap":8}', 'system');

INSERT INTO T_COST_PAGE_COMPONENT (ID, PAGE_CODE, COMPONENT_KEY, COMPONENT_TYPE, PARENT_KEY, SORT_ORDER, REF_TABLE_CODE, COMPONENT_CONFIG, CREATE_BY)
VALUES (SEQ_COST_PAGE_COMPONENT.NEXTVAL, 'user-manage', 'masterGrid', 'GRID', 'root', 1, 'CostUser', '{"height":"100%","selectionMode":"single"}', 'system');
```

**要点**：
- 主表 GRID 的 `COMPONENT_KEY` 必须是 `masterGrid`
- 无 TABS 组件

---

### 2.2 主从页面 - 不分组（如：角色用户管理）

**场景**：主表 + 从表，从表不按字段分组，所有数据显示在一个 Tab

```sql
-- 1. 主表元数据
INSERT INTO T_COST_TABLE_METADATA (ID, TABLE_CODE, TABLE_NAME, QUERY_VIEW, TARGET_TABLE, SEQUENCE_NAME, PK_COLUMN, CREATE_BY)
VALUES (v_role_id, 'CostRole', '角色', 'T_COST_ROLE', 'T_COST_ROLE', 'SEQ_COST_ROLE', 'ID', 'system');

-- 2. 从表元数据（关键：PARENT_TABLE_CODE + PARENT_FK_COLUMN）
INSERT INTO T_COST_TABLE_METADATA (ID, TABLE_CODE, TABLE_NAME, QUERY_VIEW, TARGET_TABLE, SEQUENCE_NAME, PK_COLUMN, PARENT_TABLE_CODE, PARENT_FK_COLUMN, CREATE_BY)
VALUES (v_user_role_id, 'CostUserRole', '角色用户', 'V_COST_USER_ROLE', 'T_COST_USER_ROLE', 'SEQ_COST_USER_ROLE', 'ID', 'CostRole', 'ROLE_ID', 'system');

-- 3. 页面组件
INSERT INTO T_COST_PAGE_COMPONENT VALUES (..., 'masterGrid', 'GRID', ..., 'CostRole', '{"height":"50%","selectionMode":"single"}', ...);

-- TABS 配置（关键：mode=group，不设 groupField，不设 groupValue）
INSERT INTO T_COST_PAGE_COMPONENT VALUES (..., 'detailTabs', 'TABS', ..., 'CostUserRole', 
'{
  "mode": "group",
  "tabs": [
    {"key": "users", "title": "角色用户", "columns": ["username", "realName", "deptName", "createTime"]}
  ]
}', ...);
```

**要点**：
- 从表 `PARENT_TABLE_CODE` 指向主表 tableCode
- 从表 `PARENT_FK_COLUMN` 是外键列名（大写）
- TABS `mode: "group"` 但不设 `groupField`，显示所有从表数据

---

### 2.3 主从页面 - 按字段分组（如：评估单物料明细）

**场景**：主表 + 从表，从表按某字段分组显示在多个 Tab

```sql
-- 从表元数据
INSERT INTO T_COST_TABLE_METADATA (ID, TABLE_CODE, ..., PARENT_TABLE_CODE, PARENT_FK_COLUMN, ...)
VALUES (..., 'CostEvalDetail', ..., 'CostEval', 'EVAL_ID', ...);

-- TABS 配置（关键：groupField + 每个 tab 的 value）
INSERT INTO T_COST_PAGE_COMPONENT VALUES (..., 'detailTabs', 'TABS', ..., 'CostEvalDetail', 
'{
  "mode": "group",
  "groupField": "useFlag",
  "tabs": [
    {"key": "material", "title": "原料", "value": "原料", "columns": ["materialName", "perHl", "price"]},
    {"key": "auxiliary", "title": "辅料", "value": "辅料", "columns": ["materialName", "perHl", "price"]},
    {"key": "package", "title": "包材", "value": "包材", "columns": ["materialName", "packSpec", "price"]}
  ],
  "calcRules": [...],
  "aggregates": [...]
}', ...);
```

**要点**：
- `groupField`: 分组字段名（小驼峰）
- 每个 tab 的 `value`: 该 Tab 显示的分组值
- 不同 Tab 可以显示不同的列（`columns`）

---

## 三、列元数据字段说明

### 3.0 列属性字段

| 字段 | 类型 | 说明 |
|------|------|------|
| FIELD_NAME | VARCHAR | 字段名（小驼峰），对应前端 |
| COLUMN_NAME | VARCHAR | 数据库列名（大写下划线） |
| HEADER_TEXT | VARCHAR | 列标题 |
| DATA_TYPE | VARCHAR | 数据类型：text/number/date/datetime/select |
| DISPLAY_ORDER | NUMBER | 显示顺序 |
| EDITABLE | NUMBER | 是否可编辑：0-否，1-是 |
| VISIBLE | NUMBER | 是否显示：0-隐藏，1-显示（默认1） |
| SEARCHABLE | NUMBER | 是否可搜索：0-否，1-是 |
| IS_VIRTUAL | NUMBER | 是否虚拟列：0-否，1-是（虚拟列不存数据库，只用于前端计算显示） |
| WIDTH | NUMBER | 列宽度（像素） |
| RULES_CONFIG | CLOB | 规则配置 JSON |

**示例**：
```sql
-- 普通列
INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, EDITABLE, WIDTH, CREATE_BY) 
VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, 表ID, 'productName', 'PRODUCT_NAME', '产品名称', 'text', 1, 1, 150, 'system');

-- 隐藏列（如 ID）
INSERT INTO T_COST_COLUMN_METADATA (..., VISIBLE, ...) VALUES (..., 0, ...);

-- 可搜索列
INSERT INTO T_COST_COLUMN_METADATA (..., SEARCHABLE, ...) VALUES (..., 1, ...);

-- 虚拟计算列（不存数据库）
INSERT INTO T_COST_COLUMN_METADATA (..., EDITABLE, IS_VIRTUAL, ...) VALUES (..., 0, 1, ...);
```

---

## 四、列元数据 RULES_CONFIG 配置

### 4.1 单元格样式（文字颜色）

```json
{
  "style": [
    {
      "condition": {"type": "contains", "pattern": "瓶"},
      "cellStyle": {"color": "red", "fontWeight": "bold"}
    }
  ]
}
```

条件类型：
- `contains`: 包含
- `equals`: 等于
- `startsWith`: 开头
- `endsWith`: 结尾
- `gt/lt/gte/lte`: 数值比较

---

### 4.2 行样式（背景色）

```json
{
  "style": [
    {
      "condition": {"type": "contains", "pattern": "清"},
      "rowStyle": {"backgroundColor": "#e3f2fd"}
    }
  ]
}
```

---

### 4.3 历史对比（涨跌显示）

```json
{
  "compare": {
    "enabled": true,
    "format": "both"
  }
}
```

- `format`: `arrow`(只显示箭头) / `value`(只显示差值) / `both`(都显示)
- 需要历史表 `TARGET_TABLE + '_HIS'`，字段 `HIS_TIME`

---

### 4.4 弹窗选择器回填

```json
{
  "lookup": {
    "code": "material",
    "mapping": {
      "materialName": "materialName",
      "useFlag": "useFlag",
      "price": "price"
    }
  }
}
```

- `code`: 对应 `T_COST_LOOKUP_CONFIG.LOOKUP_CODE`
- `mapping`: `{当前表字段: 弹窗表字段}`

弹窗配置表：
```sql
INSERT INTO T_COST_LOOKUP_CONFIG (ID, LOOKUP_CODE, LOOKUP_NAME, DATA_SOURCE, DISPLAY_COLUMNS, SEARCH_COLUMNS, VALUE_FIELD, LABEL_FIELD, CREATE_BY)
VALUES (SEQ_COST_LOOKUP_CONFIG.NEXTVAL, 'material', '物料选择', 'CostMaterial', 
  '[{"field":"materialCode","header":"物料编码","width":100},{"field":"materialName","header":"物料名称","width":150}]',
  '["materialCode","materialName"]', 'id', 'materialName', 'system');
```

---

### 4.5 字段验证（前端）

```json
{
  "validate": [
    {"order": 1, "type": "notZero", "message": "单价不能为0"},
    {"order": 2, "type": "min", "value": 0, "message": "单价不能为负数"}
  ]
}
```

验证类型：`required`, `notZero`, `min`, `max`, `pattern`

---

## 五、后端验证器与执行器

配置在 `T_COST_TABLE_METADATA.VALIDATION_RULES`，保存时自动执行。

### 5.1 后端验证器

```json
[
  {
    "order": 1,
    "name": "evalNoUnique",
    "sql": "SELECT COUNT(*) FROM T_COST_EVAL WHERE EVAL_NO = :evalNo AND ID != NVL(:id, -1) AND DELETED = 0",
    "condition": "result == 0",
    "message": "评估单号已存在"
  },
  {
    "order": 2,
    "name": "apexPlPositive",
    "sql": "SELECT CASE WHEN :apexPl > 0 THEN 1 ELSE 0 END FROM DUAL",
    "condition": "result == 1",
    "message": "批量必须大于0"
  }
]
```

**字段说明**：
- `order`: 执行顺序
- `name`: 规则名称
- `sql`: 验证 SQL，`:fieldName` 会替换为实际值
- `condition`: 判断条件，`result` 是 SQL 返回值
- `message`: 验证失败提示

**条件表达式**：`result == 0`, `result != 0`, `result > 0`, `result >= 1`, `result < 10`

### 5.2 后端执行器（验证通过后执行）

```json
[
  {
    "order": 1,
    "name": "autoGenerateCode",
    "sql": "SELECT COUNT(*) FROM DUAL WHERE :evalNo IS NULL",
    "condition": "result == 1",
    "message": "需要自动生成单号",
    "action": {
      "enabled": true,
      "sql": "UPDATE T_COST_EVAL SET EVAL_NO = 'EV' || TO_CHAR(SYSDATE, 'YYYYMMDD') || LPAD(SEQ_EVAL_NO.NEXTVAL, 4, '0') WHERE ID = :id",
      "description": "自动生成评估单号"
    }
  }
]
```

**执行器字段**：
- `enabled`: 是否启用
- `sql`: 执行的 SQL
- `description`: 描述（用于日志）

**执行流程**：
1. 按 `order` 顺序执行验证器
2. 验证通过后，如果有 `action` 且 `enabled=true`，执行执行器 SQL
3. 任一验证失败，立即返回错误，不执行后续规则

---

## 六、计算规则配置（TABS 组件）

### 6.1 行级计算

```json
{
  "calcRules": [
    {
      "field": "batchQty",
      "expression": "apexPl * perHl / 100",
      "triggerFields": ["perHl"],
      "condition": "useFlag !== '包材'"
    }
  ]
}
```

- `field`: 目标字段
- `expression`: 计算表达式（支持主表字段通过 broadcast 传入）
- `triggerFields`: 触发计算的字段
- `condition`: 执行条件（可选）

### 6.2 聚合计算（从表汇总到主表）

```json
{
  "aggregates": [
    {"sourceField": "costBatch", "targetField": "totalYl", "algorithm": "SUM", "filter": "useFlag === '原料'"},
    {"targetField": "totalCost", "expression": "totalYl + totalFl + totalPack"}
  ]
}
```

- `sourceField`: 从表源字段
- `targetField`: 主表目标字段
- `algorithm`: `SUM`, `AVG`, `COUNT`, `MAX`, `MIN`
- `filter`: 过滤条件
- `expression`: 表达式计算（无 sourceField 时）

### 6.3 主表字段广播

```json
{
  "broadcast": ["apexPl", "yield"]
}
```

将主表字段值广播到从表行，供计算使用。

---

## 七、菜单配置

### 7.1 目录

```sql
INSERT INTO T_COST_RESOURCE (ID, RESOURCE_CODE, RESOURCE_NAME, RESOURCE_TYPE, PAGE_CODE, ICON, ROUTE, PARENT_ID, SORT_ORDER, CREATE_BY)
VALUES (SEQ_COST_RESOURCE.NEXTVAL, 'system', '系统管理', 'DIRECTORY', NULL, 'mdi:cog', '/system', NULL, 99, 'system');
```

- `RESOURCE_TYPE`: `DIRECTORY`
- `PAGE_CODE`: NULL
- `ROUTE`: 路径前缀

### 7.2 页面

```sql
INSERT INTO T_COST_RESOURCE (ID, RESOURCE_CODE, RESOURCE_NAME, RESOURCE_TYPE, PAGE_CODE, ICON, ROUTE, PARENT_ID, SORT_ORDER, CREATE_BY)
VALUES (SEQ_COST_RESOURCE.NEXTVAL, 'user', '人员管理', 'PAGE', 'user-manage', 'mdi:account-group', '/system/user', 父级ID, 1, 'system');
```

- `RESOURCE_TYPE`: `PAGE`
- `PAGE_CODE`: 对应 `T_COST_PAGE_COMPONENT.PAGE_CODE`
- `ROUTE`: 完整路由路径

---

## 八、常见问题

### Q1: 从表不显示数据？
1. 检查 `PARENT_FK_COLUMN` 是否正确（大写列名）
2. 检查 TABS 的 `mode` 是否为 `group`
3. 检查视图是否创建

### Q2: 主表 GRID 找不到？
- 确保 `COMPONENT_KEY` 为 `masterGrid`

### Q3: 分组 Tab 数据不对？
- 检查 `groupField` 字段名（小驼峰）
- 检查每个 tab 的 `value` 是否与数据匹配

### Q4: 日期显示格式不对？
- 列 `DATA_TYPE` 用 `date`（只显示日期）或 `datetime`（显示日期时间）

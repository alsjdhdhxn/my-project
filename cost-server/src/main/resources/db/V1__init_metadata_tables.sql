-- =====================================================
-- 元数据模块表结构 + 初始化数据
-- =====================================================

-- 删除已有对象
BEGIN EXECUTE IMMEDIATE 'DROP TABLE T_COST_COLUMN_METADATA CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE T_COST_TABLE_METADATA CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE T_COST_LOOKUP_CONFIG CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE T_COST_PAGE_COMPONENT CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE T_COST_DICTIONARY_ITEM CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE T_COST_DICTIONARY_TYPE CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE T_COST_DEMO CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_COST_TABLE_METADATA'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_COST_COLUMN_METADATA'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_COST_LOOKUP_CONFIG'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_COST_PAGE_COMPONENT'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_COST_DICT_TYPE'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_COST_DICT_ITEM'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_COST_DEMO'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- =====================================================
-- 1. 表元数据
-- =====================================================
CREATE TABLE T_COST_TABLE_METADATA (
    ID                  NUMBER(19)      PRIMARY KEY,
    TABLE_CODE          VARCHAR2(64)    NOT NULL UNIQUE,
    TABLE_NAME          VARCHAR2(128)   NOT NULL,
    QUERY_VIEW          VARCHAR2(64),
    TARGET_TABLE        VARCHAR2(64)    NOT NULL,
    SEQUENCE_NAME       VARCHAR2(64),
    PK_COLUMN           VARCHAR2(64)    DEFAULT 'ID',
    PARENT_TABLE_CODE   VARCHAR2(64),
    PARENT_FK_COLUMN    VARCHAR2(64),
    AUDIT_ENABLED       NUMBER(1)       DEFAULT 0,
    DESCRIPTION         VARCHAR2(500),
    DELETED             NUMBER(1)       DEFAULT 0,
    CREATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    UPDATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    CREATE_BY           VARCHAR2(64),
    UPDATE_BY           VARCHAR2(64)
);
CREATE SEQUENCE SEQ_COST_TABLE_METADATA START WITH 1 INCREMENT BY 1;

-- =====================================================
-- 2. 列元数据
-- =====================================================
CREATE TABLE T_COST_COLUMN_METADATA (
    ID                  NUMBER(19)      PRIMARY KEY,
    TABLE_METADATA_ID   NUMBER(19)      NOT NULL,
    FIELD_NAME          VARCHAR2(64)    NOT NULL,
    COLUMN_NAME         VARCHAR2(64)    NOT NULL,
    QUERY_COLUMN        VARCHAR2(128),
    TARGET_COLUMN       VARCHAR2(64),
    HEADER_TEXT         VARCHAR2(128)   NOT NULL,
    DATA_TYPE           VARCHAR2(32)    DEFAULT 'text',
    DISPLAY_ORDER       NUMBER(5)       DEFAULT 0,
    WIDTH               NUMBER(5)       DEFAULT 120,
    VISIBLE             NUMBER(1)       DEFAULT 1,
    EDITABLE            NUMBER(1)       DEFAULT 1,
    REQUIRED            NUMBER(1)       DEFAULT 0,
    SEARCHABLE          NUMBER(1)       DEFAULT 0,
    SORTABLE            NUMBER(1)       DEFAULT 1,
    FILTERABLE          NUMBER(1)       DEFAULT 1,
    IS_VIRTUAL          NUMBER(1)       DEFAULT 0,
    DICT_TYPE           VARCHAR2(64),
    LOOKUP_CONFIG_ID    NUMBER(19),
    DEFAULT_VALUE       VARCHAR2(256),
    RULES_CONFIG        CLOB,
    DELETED             NUMBER(1)       DEFAULT 0,
    CREATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    UPDATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    CREATE_BY           VARCHAR2(64),
    UPDATE_BY           VARCHAR2(64),
    CONSTRAINT FK_COLUMN_TABLE FOREIGN KEY (TABLE_METADATA_ID) REFERENCES T_COST_TABLE_METADATA(ID)
);
CREATE SEQUENCE SEQ_COST_COLUMN_METADATA START WITH 1 INCREMENT BY 1;
CREATE INDEX IDX_COLUMN_TABLE_ID ON T_COST_COLUMN_METADATA(TABLE_METADATA_ID);

-- =====================================================
-- 3. 弹窗选择器配置
-- =====================================================
CREATE TABLE T_COST_LOOKUP_CONFIG (
    ID                  NUMBER(19)      PRIMARY KEY,
    LOOKUP_CODE         VARCHAR2(64)    NOT NULL UNIQUE,
    LOOKUP_NAME         VARCHAR2(128)   NOT NULL,
    DATA_SOURCE         VARCHAR2(200)   NOT NULL,
    DISPLAY_COLUMNS     CLOB,
    SEARCH_COLUMNS      CLOB,
    VALUE_FIELD         VARCHAR2(64)    NOT NULL,
    LABEL_FIELD         VARCHAR2(64)    NOT NULL,
    DELETED             NUMBER(1)       DEFAULT 0,
    CREATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    UPDATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    CREATE_BY           VARCHAR2(64),
    UPDATE_BY           VARCHAR2(64)
);
CREATE SEQUENCE SEQ_COST_LOOKUP_CONFIG START WITH 1 INCREMENT BY 1;

-- =====================================================
-- 4. 页面组件树
-- =====================================================
CREATE TABLE T_COST_PAGE_COMPONENT (
    ID                  NUMBER(19)      PRIMARY KEY,
    PAGE_CODE           VARCHAR2(64)    NOT NULL,
    COMPONENT_KEY       VARCHAR2(64)    NOT NULL,
    COMPONENT_TYPE      VARCHAR2(32)    NOT NULL,
    PARENT_KEY          VARCHAR2(64),
    COMPONENT_CONFIG    CLOB,
    REF_METADATA_ID     NUMBER(19),
    SLOT_NAME           VARCHAR2(32),
    SORT_ORDER          NUMBER(5)       DEFAULT 0,
    DELETED             NUMBER(1)       DEFAULT 0,
    DESCRIPTION         VARCHAR2(200),
    CREATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    UPDATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    CREATE_BY           VARCHAR2(64),
    UPDATE_BY           VARCHAR2(64)
);
CREATE SEQUENCE SEQ_COST_PAGE_COMPONENT START WITH 1 INCREMENT BY 1;
CREATE INDEX IDX_PAGE_COMP_PAGE ON T_COST_PAGE_COMPONENT(PAGE_CODE);
CREATE UNIQUE INDEX UK_PAGE_COMP_KEY ON T_COST_PAGE_COMPONENT(PAGE_CODE, COMPONENT_KEY);

-- =====================================================
-- 5. 字典类型
-- =====================================================
CREATE TABLE T_COST_DICTIONARY_TYPE (
    ID                  NUMBER(19)      PRIMARY KEY,
    TYPE_CODE           VARCHAR2(64)    NOT NULL UNIQUE,
    TYPE_NAME           VARCHAR2(128)   NOT NULL,
    DESCRIPTION         VARCHAR2(500),
    DELETED             NUMBER(1)       DEFAULT 0,
    CREATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    UPDATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    CREATE_BY           VARCHAR2(64),
    UPDATE_BY           VARCHAR2(64)
);
CREATE SEQUENCE SEQ_COST_DICT_TYPE START WITH 1 INCREMENT BY 1;

-- =====================================================
-- 6. 字典项
-- =====================================================
CREATE TABLE T_COST_DICTIONARY_ITEM (
    ID                  NUMBER(19)      PRIMARY KEY,
    TYPE_ID             NUMBER(19)      NOT NULL,
    ITEM_CODE           VARCHAR2(64)    NOT NULL,
    ITEM_NAME           VARCHAR2(128)   NOT NULL,
    ITEM_VALUE          VARCHAR2(200),
    SORT_ORDER          NUMBER(5)       DEFAULT 0,
    EXTRA_CONFIG        VARCHAR2(1000),
    DELETED             NUMBER(1)       DEFAULT 0,
    CREATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    UPDATE_TIME         TIMESTAMP       DEFAULT SYSTIMESTAMP,
    CREATE_BY           VARCHAR2(64),
    UPDATE_BY           VARCHAR2(64),
    CONSTRAINT FK_DICT_ITEM_TYPE FOREIGN KEY (TYPE_ID) REFERENCES T_COST_DICTIONARY_TYPE(ID)
);
CREATE SEQUENCE SEQ_COST_DICT_ITEM START WITH 1 INCREMENT BY 1;
CREATE INDEX IDX_DICT_ITEM_TYPE ON T_COST_DICTIONARY_ITEM(TYPE_ID);


-- =====================================================
-- 示例业务表
-- =====================================================
CREATE TABLE T_COST_DEMO (
    ID              NUMBER(19)      PRIMARY KEY,
    CODE            VARCHAR2(64)    NOT NULL,
    NAME            VARCHAR2(128)   NOT NULL,
    AMOUNT          NUMBER(18,2),
    COST_DATE       DATE,
    STATUS          VARCHAR2(32)    DEFAULT 'DRAFT',
    REMARK          VARCHAR2(512),
    DELETED         NUMBER(1)       DEFAULT 0,
    CREATE_TIME     TIMESTAMP       DEFAULT SYSTIMESTAMP,
    UPDATE_TIME     TIMESTAMP       DEFAULT SYSTIMESTAMP,
    CREATE_BY       VARCHAR2(64),
    UPDATE_BY       VARCHAR2(64)
);
CREATE SEQUENCE SEQ_COST_DEMO START WITH 1 INCREMENT BY 1;

-- =====================================================
-- 初始化数据：字典
-- =====================================================
INSERT INTO T_COST_DICTIONARY_TYPE (ID, TYPE_CODE, TYPE_NAME, DESCRIPTION, CREATE_BY)
VALUES (SEQ_COST_DICT_TYPE.NEXTVAL, 'COST_STATUS', '成本状态', '成本单据状态', 'system');

INSERT INTO T_COST_DICTIONARY_ITEM (ID, TYPE_ID, ITEM_CODE, ITEM_NAME, ITEM_VALUE, SORT_ORDER, EXTRA_CONFIG, CREATE_BY)
VALUES (SEQ_COST_DICT_ITEM.NEXTVAL, 1, 'DRAFT', '草稿', 'DRAFT', 1, '{"color":"#909399"}', 'system');
INSERT INTO T_COST_DICTIONARY_ITEM (ID, TYPE_ID, ITEM_CODE, ITEM_NAME, ITEM_VALUE, SORT_ORDER, EXTRA_CONFIG, CREATE_BY)
VALUES (SEQ_COST_DICT_ITEM.NEXTVAL, 1, 'SUBMITTED', '已提交', 'SUBMITTED', 2, '{"color":"#E6A23C"}', 'system');
INSERT INTO T_COST_DICTIONARY_ITEM (ID, TYPE_ID, ITEM_CODE, ITEM_NAME, ITEM_VALUE, SORT_ORDER, EXTRA_CONFIG, CREATE_BY)
VALUES (SEQ_COST_DICT_ITEM.NEXTVAL, 1, 'APPROVED', '已审批', 'APPROVED', 3, '{"color":"#67C23A"}', 'system');
INSERT INTO T_COST_DICTIONARY_ITEM (ID, TYPE_ID, ITEM_CODE, ITEM_NAME, ITEM_VALUE, SORT_ORDER, EXTRA_CONFIG, CREATE_BY)
VALUES (SEQ_COST_DICT_ITEM.NEXTVAL, 1, 'REJECTED', '已驳回', 'REJECTED', 4, '{"color":"#F56C6C"}', 'system');

-- =====================================================
-- 初始化数据：表元数据 + 列元数据
-- =====================================================
DECLARE
    v_table_id NUMBER;
BEGIN
    SELECT SEQ_COST_TABLE_METADATA.NEXTVAL INTO v_table_id FROM DUAL;
    
    INSERT INTO T_COST_TABLE_METADATA (ID, TABLE_CODE, TABLE_NAME, QUERY_VIEW, TARGET_TABLE, SEQUENCE_NAME, PK_COLUMN, CREATE_BY)
    VALUES (v_table_id, 'CostDemo', '成本示例表', 'T_COST_DEMO', 'T_COST_DEMO', 'SEQ_COST_DEMO', 'ID', 'system');
    
    INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, QUERY_COLUMN, TARGET_COLUMN, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, EDITABLE, REQUIRED, SEARCHABLE, CREATE_BY)
    VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, v_table_id, 'id', 'ID', 'ID', 'ID', 'ID', 'number', 0, 0, 0, 0, 'system');
    
    INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, QUERY_COLUMN, TARGET_COLUMN, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, EDITABLE, REQUIRED, SEARCHABLE, CREATE_BY)
    VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, v_table_id, 'code', 'CODE', 'CODE', 'CODE', '编码', 'text', 1, 1, 1, 1, 'system');
    
    INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, QUERY_COLUMN, TARGET_COLUMN, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, EDITABLE, REQUIRED, SEARCHABLE, CREATE_BY)
    VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, v_table_id, 'name', 'NAME', 'NAME', 'NAME', '名称', 'text', 2, 1, 1, 1, 'system');
    
    INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, QUERY_COLUMN, TARGET_COLUMN, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, EDITABLE, REQUIRED, SEARCHABLE, CREATE_BY)
    VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, v_table_id, 'amount', 'AMOUNT', 'AMOUNT', 'AMOUNT', '金额', 'number', 3, 1, 0, 0, 'system');
    
    INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, QUERY_COLUMN, TARGET_COLUMN, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, EDITABLE, REQUIRED, SEARCHABLE, CREATE_BY)
    VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, v_table_id, 'costDate', 'COST_DATE', 'COST_DATE', 'COST_DATE', '成本日期', 'date', 4, 1, 0, 1, 'system');
    
    INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, QUERY_COLUMN, TARGET_COLUMN, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, EDITABLE, REQUIRED, SEARCHABLE, DICT_TYPE, CREATE_BY)
    VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, v_table_id, 'status', 'STATUS', 'STATUS', 'STATUS', '状态', 'select', 5, 1, 0, 1, 'COST_STATUS', 'system');
    
    INSERT INTO T_COST_COLUMN_METADATA (ID, TABLE_METADATA_ID, FIELD_NAME, COLUMN_NAME, QUERY_COLUMN, TARGET_COLUMN, HEADER_TEXT, DATA_TYPE, DISPLAY_ORDER, EDITABLE, REQUIRED, SEARCHABLE, CREATE_BY)
    VALUES (SEQ_COST_COLUMN_METADATA.NEXTVAL, v_table_id, 'remark', 'REMARK', 'REMARK', 'REMARK', '备注', 'text', 6, 1, 0, 0, 'system');
    
    COMMIT;
END;
/

-- =====================================================
-- 初始化数据：页面组件树
-- =====================================================
DECLARE
    v_comp_id NUMBER;
BEGIN
    INSERT INTO T_COST_PAGE_COMPONENT (ID, PAGE_CODE, COMPONENT_KEY, COMPONENT_TYPE, PARENT_KEY, COMPONENT_CONFIG, SORT_ORDER, CREATE_BY)
    VALUES (SEQ_COST_PAGE_COMPONENT.NEXTVAL, 'cost-demo', 'root', 'LAYOUT', NULL, '{"direction":"COLUMN","gap":16}', 0, 'system');
    
    INSERT INTO T_COST_PAGE_COMPONENT (ID, PAGE_CODE, COMPONENT_KEY, COMPONENT_TYPE, PARENT_KEY, COMPONENT_CONFIG, REF_METADATA_ID, SORT_ORDER, CREATE_BY)
    VALUES (SEQ_COST_PAGE_COMPONENT.NEXTVAL, 'cost-demo', 'searchForm', 'FORM', 'root', '{"columns":4,"labelWidth":80}', 1, 1, 'system');
    
    INSERT INTO T_COST_PAGE_COMPONENT (ID, PAGE_CODE, COMPONENT_KEY, COMPONENT_TYPE, PARENT_KEY, COMPONENT_CONFIG, SORT_ORDER, CREATE_BY)
    VALUES (SEQ_COST_PAGE_COMPONENT.NEXTVAL, 'cost-demo', 'toolbar', 'LAYOUT', 'root', '{"direction":"ROW","gap":8}', 2, 'system');
    
    INSERT INTO T_COST_PAGE_COMPONENT (ID, PAGE_CODE, COMPONENT_KEY, COMPONENT_TYPE, PARENT_KEY, COMPONENT_CONFIG, SORT_ORDER, CREATE_BY)
    VALUES (SEQ_COST_PAGE_COMPONENT.NEXTVAL, 'cost-demo', 'btnCreate', 'BUTTON', 'toolbar', '{"label":"新增","icon":"i-carbon-add","type":"primary","actionType":"CREATE"}', 1, 'system');
    
    INSERT INTO T_COST_PAGE_COMPONENT (ID, PAGE_CODE, COMPONENT_KEY, COMPONENT_TYPE, PARENT_KEY, COMPONENT_CONFIG, SORT_ORDER, CREATE_BY)
    VALUES (SEQ_COST_PAGE_COMPONENT.NEXTVAL, 'cost-demo', 'btnDelete', 'BUTTON', 'toolbar', '{"label":"删除","icon":"i-carbon-trash-can","type":"danger","actionType":"DELETE"}', 2, 'system');
    
    INSERT INTO T_COST_PAGE_COMPONENT (ID, PAGE_CODE, COMPONENT_KEY, COMPONENT_TYPE, PARENT_KEY, COMPONENT_CONFIG, REF_METADATA_ID, SORT_ORDER, CREATE_BY)
    VALUES (SEQ_COST_PAGE_COMPONENT.NEXTVAL, 'cost-demo', 'mainGrid', 'GRID', 'root', '{"pageSize":20,"showCheckbox":true,"showRowNumber":true}', 1, 3, 'system');
    
    COMMIT;
END;
/
